{% if user.is_superuser %}
<div x-show="showPricingModal"
     class="fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-75 p-4 sm:p-6"
     @keydown.escape.window="showPricingModal = false"
     style="display: none;">

    {# MODAL CARD #}
    <div class="relative bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]"
         @click.away="showPricingModal = false">

        {# HEADER #}
        <div class="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
            <h3 class="text-2xl font-bold text-gray-800">
                Set Product Pricing
            </h3>
            <button @click="showPricingModal = false" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        {# FORM #}
        <form @submit.prevent="submitPricingUpdate()" class="flex flex-col flex-1 min-h-0" novalidate>

            {# SCROLLABLE CONTENT #}
            <div class="flex-1 overflow-y-auto p-6 space-y-4">

                {# --- Product Info --- #}
                <div>
                    <span class="font-semibold text-gray-700 block mb-1">Product</span>
                    <p class="text-lg text-indigo-600 font-medium" x-text="pricingData.name"></p>
                </div>

                <div>
                    <span class="font-semibold text-gray-700 block mb-1">Latest Quoted Cost (Base Cost)</span>
                    <p class="text-lg font-mono"
                       :class="pricingData.base_cost ? 'text-gray-900' : 'text-red-500'"
                       x-text="pricingData.base_cost ? `RM ${pricingData.base_cost.toFixed(2)}` : 'N/A (No quote found)'">
                    </p>
                    <p x-show="!pricingData.base_cost" class="text-xs text-red-500 mt-1">
                        A price cannot be calculated without a base cost.
                    </p>
                </div>

                <hr class="border-gray-100">

                {# --- Pricing Inputs --- #}
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="id_pricing_profit_margin" class="font-semibold text-gray-700 block mb-1">Profit Margin (%)</label>
                        <input type="number" id="id_pricing_profit_margin"
                               x-model.number="pricingData.profit_margin"
                               @input.debounce.300ms="calculatePriceFromMargin()"
                               :disabled="!pricingData.base_cost"
                               step="1" min="0"
                               class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100">
                    </div>

                    <div>
                        <label for="id_pricing_selling_price" class="font-semibold text-gray-700 block mb-1">Selling Price (RM)</label>
                        <input type="number" id="id_pricing_selling_price"
                               x-model.number="pricingData.selling_price"
                               @input.debounce.300ms="calculateMarginFromPrice()"
                               :disabled="!pricingData.base_cost"
                               step="0.01" min="0"
                               class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100">
                    </div>
                </div>

                <hr class="border-gray-100">

                {# --- Commission Section --- #}
                <div>
                    <span class="font-semibold text-gray-700 block mb-2">Commission Estimates</span>

                    <div x-show="pricingProfit === null" class="text-xs text-gray-500 italic">
                        Set a valid Selling Price > Cost to view commissions.
                    </div>

                    <div x-show="pricingProfit !== null" class="space-y-2 max-h-32 overflow-y-auto pr-2 border border-gray-100 rounded-md p-2 bg-gray-50">
                        <template x-for="group in $store.globals.allUserGroupsList" :key="group.id">
                            <div x-show="group.commission_percentage > 0" class="flex justify-between items-center text-sm p-2 bg-white rounded shadow-sm">
                                <span class="text-gray-700 font-medium" x-text="group.name"></span>
                                <div class="text-right">
                                    <div class="text-green-600 font-bold" x-text="`RM ${(pricingProfit * (group.commission_percentage / 100)).toFixed(2)}`"></div>
                                    <div class="text-[10px] text-gray-400" x-text="`${group.commission_percentage}% of profit`"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <hr class="border-gray-100">

                {# --- PROMOTIONAL SECTION --- #}
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-bold text-gray-800 block">Promotional Item</span>
                            <span class="text-xs text-gray-500">Enable for special pricing/display.</span>
                        </div>
                        <div class="relative inline-block w-12 align-middle select-none">
                            <input type="checkbox" name="is_promotion" id="id_is_promotion"
                                   x-model="pricingData.is_promotion"
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                            <label for="id_is_promotion" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <div x-show="pricingData.is_promotion"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 h-0"
                         x-transition:enter-end="opacity-100 h-auto"
                         class="mt-4 pt-4 border-t border-gray-200 space-y-4">

                        {# --- UPDATED: Consistent Input Field --- #}
                        <div>
                            <label for="id_promotion_rate" class="font-semibold text-gray-700 block mb-1">
                                Discount Rate (%)
                            </label>
                            <input type="number" id="id_promotion_rate"
                                   x-model.number="pricingData.promotion_rate"
                                   step="0.01" min="0" max="100"
                                   class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>

                        {# Final Price Display #}
                        <div class="bg-white p-3 rounded-md border border-red-100 shadow-sm flex justify-between items-center"
                             x-show="pricingData.selling_price > 0">
                            <div>
                                <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Final Price</span>
                            </div>
                            <div class="text-right">
                                <span class="block text-xs text-gray-400 line-through mr-1"
                                      x-show="pricingData.promotion_rate > 0"
                                      x-text="`RM ${parseFloat(pricingData.selling_price).toFixed(2)}`">
                                </span>
                                <span class="text-xl font-bold text-red-600"
                                      x-text="`RM ${(pricingData.selling_price * (1 - ((pricingData.promotion_rate || 0) / 100))).toFixed(2)}`">
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    .toggle-checkbox:checked { right: 0; border-color: #ef4444; }
                    .toggle-checkbox:checked + .toggle-label { background-color: #ef4444; }
                    .toggle-checkbox { right: 50%; transition: all 0.3s ease; }
                    .toggle-label { width: 3rem; height: 1.5rem; }
                </style>
            </div>

            {# FOOTER #}
            <div class="p-6 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0 rounded-b-lg">
                <button type="button" @click="showPricingModal = false"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </button>
                <button type="submit"
                        :disabled="pricingIsSubmitting"
                        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <span x-show="!pricingIsSubmitting">Save Pricing</span>
                    <span x-show="pricingIsSubmitting">Saving...</span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% extends 'base.html' %}

{% block full_width_banner %}{% endblock %}
{% block full_width_sticky_nav %}{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

{# --- JSON Data for Alpine --- #}
{{ all_categories_flat_list|json_script:"all-categories-data" }}
{{ group_to_categories_map|json_script:"group-categories-data" }}

{{ all_categories_list_json|json_script:"all-categories-list-data" }}
{{ all_suppliers_list_json|json_script:"all-suppliers-list-data" }}
{{ all_image_categories_json|json_script:"all-image-categories-data" }}

{# --- START: MODIFIED SCRIPT BLOCK --- #}
<script>
    document.addEventListener('alpine:init', () => {
        // --- 1. Global Store for Filters & Modal Data ---
        Alpine.store('globals', {
            allCategoriesFlat: JSON.parse(document.getElementById('all-categories-data').textContent),
            groupCategoriesMap: JSON.parse(document.getElementById('group-categories-data').textContent),
            allCategoriesList: JSON.parse(document.getElementById('all-categories-list-data').textContent),
            allSuppliersList: JSON.parse(document.getElementById('all-suppliers-list-data').textContent),
            allImageCategories: JSON.parse(document.getElementById('all-image-categories-data').textContent),
            csrfToken: '',
            selectedCategoryId: null, // For image filter
            invoiceToOpen: null // <-- ADD THIS
        });

        // --- 2. Global Store for Image Management ---
        Alpine.store('images', {
            galleryImages: [],
            allProducts: [],
            allPosts: [],
            selectedImageToAssign: null,
            bulkSelectedImageIds: [],

            showAssignProductModal: false,
            assignProductModalSearchTerm: '',
            assignProductModalSelectedProducts: [],
            assignProductModalAssignmentType: 'featured',
            assignProductModalIsSubmitting: false,

            showAssignPostModal: false,
            assignPostModalSearchTerm: '',
            assignPostModalSelectedPosts: [],
            assignPostModalAssignmentType: 'featured',
            assignPostModalIsSubmitting: false,

            showBulkAssignModal: false,
            bulkAssignTargetType: 'product',
            bulkAssignSearchTerm: '',
            bulkAssignTargetId: null,
            bulkAssignIsSubmitting: false,

            // --- Getters ---
            get filteredImages() {
                if (Alpine.store('globals').selectedCategoryId === null) return this.galleryImages;
                return this.galleryImages.filter(img => img.category_id == Alpine.store('globals').selectedCategoryId);
            },
            get filteredProductsForModal() {
                if (!this.assignProductModalSearchTerm) return this.allProducts;
                const search = this.assignProductModalSearchTerm.toLowerCase();
                return this.allProducts.filter(p => p.name.toLowerCase().includes(search) || (p.sku && p.sku.toLowerCase().includes(search)));
            },
            get filteredPostsForModal() {
                if (!this.assignPostModalSearchTerm) return this.allPosts;
                const search = this.assignPostModalSearchTerm.toLowerCase();
                return this.allPosts.filter(p => p.title.toLowerCase().includes(search));
            },
            get filteredProductsForBulkAssign() {
                if (!this.bulkAssignSearchTerm) return this.allProducts;
                const search = this.bulkAssignSearchTerm.toLowerCase();
                return this.allProducts.filter(p => p.name.toLowerCase().includes(search) || (p.sku && p.sku.toLowerCase().includes(search)));
            },
            get filteredPostsForBulkAssign() {
                if (!this.bulkAssignSearchTerm) return this.allPosts;
                const search = this.bulkAssignSearchTerm.toLowerCase();
                return this.allPosts.filter(p => p.title.toLowerCase().includes(search));
            },

            // --- Methods ---
            async handleImageUpload(event) {
                const form = event.target;
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type=submit]');
                if (!form.querySelector('input[type=file]').files.length) return;
                submitButton.disabled = true;
                submitButton.textContent = 'Uploading...';
                try {
                    const response = await fetch(`{% url 'images:ajax_upload_image' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json' },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        data.images.forEach(img => this.galleryImages.unshift(img));
                        form.reset();
                        alert('Image(s) uploaded successfully!');
                    } else { throw new Error(data.errors || 'Upload failed'); }
                } catch (err) { alert('Upload error: ' + err.message); }
                finally { submitButton.disabled = false; submitButton.textContent = 'Upload Image(s)'; }
            },
            async deleteImage(imageId) {
                if (!confirm('Are you sure?')) return;
                try {
                    const response = await fetch(`/images/api/delete-image/${imageId}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.galleryImages.splice(this.galleryImages.findIndex(img => img.id === imageId), 1);
                        alert(data.message);
                    } else { throw new Error(data.error || 'Failed to delete'); }
                } catch (err) { alert('Delete error: ' + err.message); }
            },
            openAssignProductModal(image) {
                this.selectedImageToAssign = image;
                this.assignProductModalSearchTerm = '';
                this.assignProductModalAssignmentType = 'featured';
                this.updateProductModalSelections();
                this.showAssignProductModal = true;
            },
            updateProductModalSelections() {
                if (!this.selectedImageToAssign) return;
                const imageId = this.selectedImageToAssign.id;
                if (this.assignProductModalAssignmentType === 'featured') {
                    this.assignProductModalSelectedProducts = this.allProducts
                        .filter(p => p.featured_image_id === imageId).map(p => p.id);
                } else {
                    this.assignProductModalSelectedProducts = this.allProducts
                        .filter(p => p.gallery_image_ids.includes(imageId)).map(p => p.id);
                }
            },
            async submitProductAssignment() {
                this.assignProductModalIsSubmitting = true;
                const payload = {
                    image_id: this.selectedImageToAssign.id,
                    product_ids: this.assignProductModalSelectedProducts,
                    assignment_type: this.assignProductModalAssignmentType
                };
                try {
                    const response = await fetch(`{% url 'images:ajax_assign_to_products' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json', 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.allProducts = data.all_products; // Update local state
                        this.showAssignProductModal = false;
                        alert('Product assignments updated!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else { throw new Error(data.error || 'Failed to save'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.assignProductModalIsSubmitting = false; }
            },
            // (Other image store functions: openAssignPostModal, submitPostAssignment, openBulkAssignModal, submitBulkAssignment, etc.)
            // (These are omitted for brevity but should be moved here from the old x-data)
            openAssignPostModal(image) {
                this.selectedImageToAssign = image;
                this.assignPostModalSearchTerm = '';
                this.assignPostModalAssignmentType = 'featured';
                this.updatePostModalSelections();
                this.showAssignPostModal = true;
            },
            updatePostModalSelections() {
                if (!this.selectedImageToAssign) return;
                const imageId = this.selectedImageToAssign.id;
                if (this.assignProductModalAssignmentType === 'featured') {
                    this.assignPostModalSelectedPosts = this.allPosts
                        .filter(p => p.featured_image_id === imageId).map(p => p.id);
                } else {
                    this.assignPostModalSelectedPosts = this.allPosts
                        .filter(p => p.gallery_image_ids.includes(imageId)).map(p => p.id);
                }
            },
            async submitPostAssignment() {
                this.assignPostModalIsSubmitting = true;
                const payload = {
                    image_id: this.selectedImageToAssign.id,
                    post_ids: this.assignPostModalSelectedPosts,
                    assignment_type: this.assignPostModalAssignmentType
                };
                try {
                    const response = await fetch(`{% url 'images:ajax_assign_to_posts' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json', 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.allPosts = data.all_posts;
                        this.showAssignPostModal = false;
                        alert('Post assignments updated!');
                    } else { throw new Error(data.error || 'Failed to save'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.assignPostModalIsSubmitting = false; }
            },
            openBulkAssignModal() {
                if (this.bulkSelectedImageIds.length === 0) {
                    alert('Please select one or more images first.');
                    return;
                }
                this.bulkAssignTargetType = 'product';
                this.bulkAssignSearchTerm = '';
                this.bulkAssignTargetId = null;
                this.showBulkAssignModal = true;
            },
            async submitBulkAssignment() {
                if (this.bulkAssignIsSubmitting || !this.bulkAssignTargetId || this.bulkSelectedImageIds.length === 0) return;
                this.bulkAssignIsSubmitting = true;
                const payload = {
                    image_ids: this.bulkSelectedImageIds,
                    target_id: this.bulkAssignTargetId,
                    target_type: this.bulkAssignTargetType
                };
                try {
                    const response = await fetch(`{% url 'images:ajax_bulk_assign' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json', 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.allProducts = data.all_products;
                        this.allPosts = data.all_posts;
                        this.showBulkAssignModal = false;
                        this.bulkSelectedImageIds = [];
                        alert('Images successfully assigned to gallery!');
                    } else { throw new Error(data.error || 'Failed to save'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.bulkAssignIsSubmitting = false; }
            }
        });

        Alpine.data('productAccordionRow', (productId) => ({
            id: productId,
            open: false,
            batches: [],
            isLoading: false,
            hasLoaded: false,

            async toggle() {
                this.open = !this.open;
                if (this.open && !this.hasLoaded) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/inventory/api/product-batches/${this.id}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch batch data.');

                        const data = await response.json();
                        this.batches = data.batches;
                        this.hasLoaded = true;
                    } catch (error) {
                        console.error(`Failed to load batches for product ${this.id}:`, error);
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }));

        Alpine.data('quotationAccordionRow', (quotationId) => ({
            id: quotationId,
            open: false,
            items: [], // Will hold the line items
            isLoading: false,
            hasLoaded: false,

            async toggle() {
                this.open = !this.open;
                if (this.open && !this.hasLoaded) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/inventory/api/quotation-items/${this.id}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch quotation items.');

                        const data = await response.json();
                        this.items = data.items;
                        this.hasLoaded = true;
                    } catch (error) {
                        console.error(`Failed to load items for quotation ${this.id}:`, error);
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }));

        // --- 3. Component Data Functions (MOVED HERE) ---
        Alpine.data('productTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            filterGroup: '',
            filterCategory: '',
            allCategories: [],
            groupCategoriesMap: {},
            init() {
                this.allCategories = Alpine.store('globals').allCategoriesFlat;
                this.groupCategoriesMap = Alpine.store('globals').groupCategoriesMap;

                // --- START DEBUG LOG (Products Tab) ---
                console.log('[DEBUG Prod. Tab Init] Local component data set:');
                console.log('[DEBUG Prod. Tab] this.allCategories:', JSON.stringify(this.allCategories));
                console.log('[DEBUG Prod. Tab] this.groupCategoriesMap:', JSON.stringify(this.groupCategoriesMap));
                // --- END DEBUG LOG (Products Tab) ---

                this.fetchProducts(1);
            },
            get availableCategories() {
                // --- START DEBUG LOG (Products Tab) ---
                console.log(`[DEBUG Prod. Tab Getter] availableCategories called. filterGroup is: "${this.filterGroup}"`);
                // --- END DEBUG LOG (Products Tab) ---

                if (!this.filterGroup) {
                    console.log('[DEBUG Prod. Tab Getter] Returning allCategories.');
                    return this.allCategories;
                }
                const globalCategoriesMap = Alpine.store('globals').groupCategoriesMap;

                if (globalCategoriesMap && globalCategoriesMap[this.filterGroup]) {
                    const categories = globalCategoriesMap[this.filterGroup] || [];
                    console.log(`[DEBUG Prod. Tab Getter] Returning categories for group:`, categories);
                    return categories;
                }

                console.warn('[DEBUG Prod. Tab Getter] Group not found in map or map is missing. Returning [].');
                return [];
            },
            async fetchProducts(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText, group: this.filterGroup, category: this.filterCategory });
                try {
                    const response = await fetch(`{% url 'product:api_manage_products' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch products:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() {
                console.log('[DEBUG Prod. Tab] clearFilters() called.');
                this.filterText = ''; this.filterGroup = ''; this.filterCategory = '';
                this.fetchProducts(1);
            },
            setGroupFilter(groupName) {
                // --- START DEBUG LOG (Products Tab) ---
                console.log(`[DEBUG Prod. Tab] setGroupFilter() called with: "${groupName}"`);
                // --- END DEBUG LOG (Products Tab) ---
                this.filterGroup = groupName;
                this.filterCategory = '';
                this.fetchProducts(1);
            },
            setCategoryFilter(categoryName) {
                console.log(`[DEBUG Prod. Tab] setCategoryFilter() called with: "${categoryName}"`);
                this.filterCategory = categoryName;
                this.fetchProducts(1);
            }
        }));

        Alpine.data('inventoryTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            filterGroup: '',
            filterCategory: '',
            allCategories: [],
            groupCategoriesMap: {},
            init() {
                this.allCategories = Alpine.store('globals').allCategoriesFlat;
                this.groupCategoriesMap = Alpine.store('globals').groupCategoriesMap;

                // --- START DEBUG LOG (Inventory Tab) ---
                console.log('[DEBUG Inv. Tab Init] Local component data set:');
                console.log('[DEBUG Inv. Tab] this.allCategories:', JSON.stringify(this.allCategories));
                console.log('[DEBUG Inv. Tab] this.groupCategoriesMap:', JSON.stringify(this.groupCategoriesMap));
                // --- END DEBUG LOG (Inventory Tab) ---

                this.fetchInventory(1);
            },
            get availableCategories() {
                // --- START DEBUG LOG (Inventory Tab) ---
                console.log(`[DEBUG Inv. Tab Getter] availableCategories called. filterGroup is: "${this.filterGroup}"`);
                // --- END DEBUG LOG (Inventory Tab) ---

                if (!this.filterGroup) {
                    console.log('[DEBUG Inv. Tab Getter] Returning allCategories.');
                    return this.allCategories;
                }
                const globalCategoriesMap = Alpine.store('globals').groupCategoriesMap;

                if (globalCategoriesMap && globalCategoriesMap[this.filterGroup]) {
                    const categories = globalCategoriesMap[this.filterGroup] || [];
                    console.log(`[DEBUG Inv. Tab Getter] Returning categories for group:`, categories);
                    return categories;
                }

                console.warn('[DEBUG Inv. Tab Getter] Group not found in map or map is missing. Returning [].');
                return [];
            },
            async fetchInventory(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText, group: this.filterGroup, category: this.filterCategory });
                try {
                    const response = await fetch(`{% url 'inventory:api_manage_inventory' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch inventory:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() {
                console.log('[DEBUG Inv. Tab] clearFilters() called.');
                this.filterText = ''; this.filterGroup = ''; this.filterCategory = ''; this.fetchInventory(1);
            },
            setGroupFilter(groupName) {
                // --- START DEBUG LOG (Inventory Tab) ---
                console.log(`[DEBUG Inv. Tab] setGroupFilter() called with: "${groupName}"`);
                // --- END DEBUG LOG (Inventory Tab) ---
                this.filterGroup = groupName; this.filterCategory = ''; this.fetchInventory(1);
            },
            setCategoryFilter(categoryName) {
                console.log(`[DEBUG Inv. Tab] setCategoryFilter() called with: "${categoryName}"`);
                this.filterCategory = categoryName;
                this.fetchInventory(1);
            },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('quotationsTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            init() { this.fetchQuotations(1); },
            async fetchQuotations(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText });
                try {
                    const response = await fetch(`{% url 'inventory:api_manage_quotations' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch quotations:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() { this.filterText = ''; this.fetchQuotations(1); },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('imageTabManager', () => ({
            isLoading: true,
            init() {
                if (Alpine.store('images').galleryImages.length > 0) {
                    this.isLoading = false;
                    return; // Already loaded
                }
                this.fetchInitialImageData();
            },
            async fetchInitialImageData() {
                this.isLoading = true;
                const apiHeaders = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
                try {
                    const [imagesRes, productsRes, postsRes] = await Promise.all([
                        fetch(`{% url 'images:ajax_get_images' %}`, { headers: apiHeaders }),
                        fetch(`{% url 'product:api_manage_products' %}?page=1&limit=10000`, { headers: apiHeaders }),
                        fetch(`{% url 'blog:api_manage_posts' %}?page=1&limit=10000`, { headers: apiHeaders })
                    ]);

                    if (!imagesRes.ok || !productsRes.ok || !postsRes.ok) {
                        throw new Error('One or more API requests failed');
                    }

                    const imagesData = await imagesRes.json();
                    const productsData = await productsRes.json();
                    const postsData = await postsRes.json();

                    Alpine.store('images').galleryImages = imagesData.images;
                    Alpine.store('images').allProducts = productsData.items;
                    Alpine.store('images').allPosts = postsData.items;

                } catch (error) {
                    console.error('Failed to load initial image data:', error);
                    alert('Could not load image gallery data.');
                } finally {
                    this.isLoading = false;
                }
            }
        }));
    });
</script>


{# --- Main Alpine Component (NOW SIMPLIFIED) --- #}
{# --- START MODIFICATION --- #}
<div id="manage-tools-root" class="w-full max-w-6xl mx-auto" x-data="{
{# --- END MODIFICATION --- #}
    tab: window.location.hash || '#quotations',
    uploadQuotationModalOpen: false,
    createQuotationModalOpen: false,
    editModalOpen: false,
    uploadBatchModalOpen: false,
    receiveStockModalOpen: false,

    // invoiceToOpen: null, // <-- REMOVED

    // --- State for Modals (Managed by parent) ---
    receiveStockData: {
        invoiceItemId: '', invoiceId: '', productId: '', productName: '',
        productSku: '', supplierId: '', supplierName: '',
        quotationId: '', batch_number: '',
        received_date: '{{ today_date|date:"Y-m-d" }}', expiry_date: '',
        quantity_to_receive: '',
        max_receivable: ''
    },
    currentInvoice: {
        invoice_id: '', status: '', payment_date: '', notes: '', update_url: ''
    },

    // --- State for Product Edit Modal (Managed by parent) ---
    showProductEditModal: false,
    productEditIsLoading: false,
    productEditIsSubmitting: false,
    productEditData: {
        id: null, name: '', sku: '', description: '', members_only: false,
        categories: [], suppliers: [], featured_image: null, gallery_images: [],
        update_url: '', selectedImageUrl: ''
    },
    productEditErrors: {},

    get selectedGalleryImages() {
        if (!this.productEditData.id) return [];
        return Alpine.store('images').galleryImages.filter(image =>
            this.productEditData.gallery_images.includes(image.id)
        );
    },

    // --- INIT ---
    init() {
        const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (tokenInput) {
            Alpine.store('globals').csrfToken = tokenInput.value;
        } else {
            console.error('CSRF token not found on page.');
        }

        // --- START DEBUG LOG 1 ---
        console.log('[DEBUG Root Init] Globals store populated:');
        try {
            console.log('[DEBUG] allCategoriesFlat:', JSON.stringify(Alpine.store('globals').allCategoriesFlat));
            console.log('[DEBUG] groupCategoriesMap:', JSON.stringify(Alpine.store('globals').groupCategoriesMap));
        } catch (e) {
            console.error('[DEBUG] Failed to stringify global data:', e);
            console.log('[DEBUG] Raw allCategoriesFlat:', Alpine.store('globals').allCategoriesFlat);
            console.log('[DEBUG] Raw groupCategoriesMap:', Alpine.store('globals').groupCategoriesMap);
        }
        // --- END DEBUG LOG 1 ---


        // Check for the special hash to open an invoice
        const hash = window.location.hash;
        // ... (rest of init function is unchanged) ...
    },

    // --- Modal Functions (Live in parent) ---
    async fetchInvoiceData(invoiceId) {
        try {
            const url = `/sales/invoice/${invoiceId}/edit/`;
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
            });
            if (!response.ok) { throw new Error(`Network response error (${response.status})`); }
            this.currentInvoice = await response.json();
            this.editModalOpen = true;
        } catch (error) {
            console.error('Fetch invoice data error:', error);
            alert('Could not load invoice details.');
        }
    },
    async submitInvoiceUpdate() {
        const form = document.getElementById('edit-invoice-form'); if (!form) return;
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type=submit]');
        submitButton.disabled = true; submitButton.innerHTML = 'Saving...';
        try {
            const response = await fetch(this.currentInvoice.update_url, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': Alpine.store('globals').csrfToken },
                body: formData
            });
            const data = await response.json();
            if (response.ok && data.success) {
                this.editModalOpen = false;
                alert('Invoice updated successfully!');
                // We reload the page because the invoice list is static
                alert('Page will now refresh to show invoice status update.');
                window.location.reload();
            } else {
                 let errorMsg = 'Update failed:\n' + (data.error || '');
                 if (data.errors) {
                     for (const field in data.errors) {
                         errorMsg += `- ${field}: ${data.errors[field].join(', ')}\n`;
                     }
                 }
                  alert(errorMsg);
            }
        } catch (error) {
            alert('Network error during update.');
        } finally {
             submitButton.disabled = false; submitButton.innerHTML = 'Save Changes';
        }
    },
    openReceiveStockModal(data) {
        if (!this.receiveStockModalOpen) {
             this.receiveStockData.received_date = '{{ today_date|date:"Y-m-d" }}';
             this.receiveStockData.batch_number = '';
             this.receiveStockData.expiry_date = '';
        }
        // 'data.quantity' is the remaining quantity.
        this.receiveStockData = {
            ...this.receiveStockData,
            ...data,
            quantity_to_receive: data.quantity, // This is the field the user will edit
            max_receivable: data.quantity       // This is the static max value
        };
        this.receiveStockModalOpen = true;
    },
    closeReceiveStockModal() { this.receiveStockModalOpen = false; },

    // --- Product Edit Modal Functions ---
    async openProductEditModal(productId) {
        this.productEditIsLoading = true;
        this.showProductEditModal = true;
        this.productEditErrors = {};
        try {
            const url = `/manage/edit/${productId}/`;
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
            });
            if (!response.ok) { throw new Error('Failed to load product data.'); }
            const data = await response.json();
            this.productEditData = data;
        } catch (err) {
            this.productEditErrors = { '__all__': [err.message || 'Could not load data.'] };
        } finally {
            this.productEditIsLoading = false;
        }
    },
    async submitProductEdit() {
        this.productEditIsSubmitting = true;
        this.productEditErrors = {};
        const formData = new FormData();
        formData.append('name', this.productEditData.name);
        formData.append('sku', this.productEditData.sku || '');
        formData.append('description', this.productEditData.description || '');
        if (this.productEditData.members_only) {
            formData.append('members_only', 'on');
        }
        if (this.productEditData.featured_image) {
            formData.append('featured_image', this.productEditData.featured_image);
        } else {
            formData.append('featured_image', '');
        }
        this.productEditData.categories.forEach(id => formData.append('categories', id));
        this.productEditData.suppliers.forEach(id => formData.append('suppliers', id));
        this.productEditData.gallery_images.forEach(id => formData.append('gallery_images', id));

        try {
            const response = await fetch(this.productEditData.update_url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': Alpine.store('globals').csrfToken,
                    'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json'
                },
                body: formData
            });
            const data = await response.json();
            if (response.ok && data.success) {
                this.showProductEditModal = false;
                alert('Product updated successfully!');
                window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'inventory' } }));
            } else {
                this.productEditErrors = data.errors || { '__all__': ['An unknown error occurred.'] };
            }
        } catch (err) {
            this.productEditErrors = { '__all__': [err.message || 'A network error occurred.'] };
        } finally {
            this.productEditIsSubmitting = false;
        }
    },

    // --- Image Gallery Modal Functions (Passthrough to store) ---
    // These properties are now bound to the store in the template
    handleImageUpload(event) { Alpine.store('images').handleImageUpload(event); },
    deleteImage(id) { Alpine.store('images').deleteImage(id); },
    openAssignProductModal(image) { Alpine.store('images').openAssignProductModal(image); },
    openAssignPostModal(image) { Alpine.store('images').openAssignPostModal(image); },
    openBulkAssignModal() { Alpine.store('images').openBulkAssignModal(); },
    submitProductAssignment() { Alpine.store('images').submitProductAssignment(); },
    submitPostAssignment() { Alpine.store('images').submitPostAssignment(); },
    submitBulkAssignment() { Alpine.store('images').submitBulkAssignment(); },
    updateProductModalSelections() { Alpine.store('images').updateProductModalSelections(); },
    updatePostModalSelections() { Alpine.store('images').updatePostModalSelections(); },

    // --- Getters for Image Modals (Bound to store) ---
    get filteredImages() { return Alpine.store('images').filteredImages; },
    get filteredProductsForModal() { return Alpine.store('images').filteredProductsForModal; },
    get filteredPostsForModal() { return Alpine.store('images').filteredPostsForModal; },
    get filteredProductsForBulkAssign() { return Alpine.store('images').filteredProductsForBulkAssign; },
    get filteredPostsForBulkAssign() { return Alpine.store('images').filteredPostsForBulkAssign; }

}"
@open-product-edit-modal.window="openProductEditModal($event.detail)"
@open-upload-quotation-modal.window="uploadQuotationModalOpen = true"
@open-create-quotation-modal.window="createQuotationModalOpen = true"
@open-upload-batch-modal.window="uploadBatchModalOpen = true"

@close-receive-modal.window="closeReceiveStockModal()"
{# --- Bind image store modal events --- #}
@images-handle-upload.window="Alpine.store('images').handleImageUpload($event)"
@images-delete.window="Alpine.store('images').deleteImage($event.detail)"
@images-open-assign-product.window="Alpine.store('images').openAssignProductModal($event.detail)"
@images-open-assign-post.window="Alpine.store('images').openAssignPostModal($event.detail)"
@images-open-bulk-assign.window="Alpine.store('images').openBulkAssignModal()"
@images-submit-product-assign.window="Alpine.store('images').submitProductAssignment()"
@images-submit-post-assign.window="Alpine.store('images').submitPostAssignment()"
@images-submit-bulk-assign.window="Alpine.store('images').submitBulkAssignment()"
@images-update-product-selections.window="Alpine.store('images').updateProductModalSelections()"
@images-update-post-selections.window="Alpine.store('images').updatePostModalSelections()"
>

    {% if messages %}
    <div class="mb-4 space-y-2">
        {% for message in messages %}
         <div class="px-4 py-3 rounded relative
            {% if message.tags == 'success' %} bg-green-100 border border-green-400 text-green-700
            {% elif message.tags == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700
            {% elif message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700
            {% else %} bg-blue-100 border border-blue-400 text-blue-700
            {% endif %}" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# --- The Tabs --- #}
    {% include 'core/partials/manage_tabs.html' %}

    {# --- Tab Content --- #}
    <div class="pt-8">
        <div x-show="tab === '#quotations'" id="quotations" x-cloak>
             {% include 'inventory/partials/quotations_tab.html' %}
        </div>

        <div x-show="tab === '#invoices'" id="invoices" x-cloak>
            {% include 'inventory/partials/invoices_tab.html' %}
        </div>

        <div x-show="tab === '#inventory'" id="inventory" x-cloak>
             {% include 'inventory/partials/inventory_tab.html' %}
        </div>

        <div x-show="tab === '#products'" id="products" x-cloak>
             {% include 'product/manage_products_tab.html' %}
        </div>

        <div x-show="tab === '#blog'" id="blog" x-cloak>
             {% include 'blog/manage_blog_tab.html' %}
        </div>

        <div x-show="tab === '#seo'" id="seo" x-cloak>
             {% include 'seo/manage_seo_tab.html' %}
        </div>

        <div x-show="tab === '#images'" id="images" x-cloak>
             {% include 'images/manage_images_tab.html' %}
        </div>
    </div>

    {# --- All Modals --- #}
    {% include 'inventory/partials/upload_quotation_modal.html' %}
    {% include 'inventory/partials/create_quotation_modal.html' %}
    {% include 'inventory/partials/edit_invoice_modal.html' %}
    {% include 'inventory/partials/upload_batch_modal.html' %}
    {% include 'inventory/partials/receive_stock_modal.html' %}
    <div x-show="$store.images.showAssignProductModal">
        {% include 'images/partials/assign_product_modal.html' %}
    </div>
    <div x-show="$store.images.showAssignPostModal">
        {% include 'images/partials/assign_post_modal.html' %}
    </div>
    <div x-show="$store.images.showBulkAssignModal">
        {% include 'images/partials/bulk_assign_modal.html' %}
    </div>
    {% include 'product/partials/product_edit_modal.html' %}

</div>

{# --- JavaScript for Receive Stock AJAX Submission (Unchanged) --- #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const receiveStockForm = document.getElementById('receive-stock-form');
    if (receiveStockForm) {
        const errorContainer = document.getElementById('receive-stock-error-container');
        const errorMessage = document.getElementById('receive-stock-error-message');

        receiveStockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Get the token from the main Alpine STORE
            const csrfToken = Alpine.store('globals').csrfToken;
            const formData = new FormData(receiveStockForm);
            const submitButton = receiveStockForm.querySelector('button[type=submit]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            errorContainer.classList.add('hidden');

            try {
                const response = await fetch(receiveStockForm.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    // Find the main Alpine component's root DOM node
                    const rootComponent = document.getElementById('manage-tools-root'); // This ID now exists
                    if (rootComponent && rootComponent.__x) {
                        const rootData = rootComponent.__x.data; // Access Alpine's data
                        const fullInvoiceId = rootData.receiveStockData.invoiceId;

                        alert('Stock received successfully! The page will refresh to show updated data.');

                        if (fullInvoiceId) {
                            // --- START FINAL FIX ---
                            // Construct the full, absolute URL to force a reload.
                            // window.location.origin = "http://localhost:8000" (example)
                            // window.location.pathname = "/manage/" (example)
                            const newUrl = window.location.origin + window.location.pathname + '#invoices?open=' + fullInvoiceId;

                            // Use window.location.href to force a full navigation
                            window.location.href = newUrl;
                            // --- END FINAL FIX ---
                        } else {
                            window.location.reload();
                        }
                    } else {
                        // Fallback if the root element isn't found
                        alert('Stock received successfully! Reloading page.');
                        window.location.reload();
                    }
                } else {
                    let errorText = data.error || (data.errors ? JSON.stringify(data.errors) : 'An error occurred.');
                    errorMessage.textContent = errorText;
                    errorContainer.classList.remove('hidden');
                }
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}.`;
                errorContainer.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Confirm Stock Received';
            }
        });
    }

});
</script>
{% endblock %}

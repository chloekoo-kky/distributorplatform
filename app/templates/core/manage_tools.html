{% extends 'base.html' %}
{% load static %}

{% block full_width_banner %}{% endblock %}
{% block full_width_sticky_nav %}{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<script src="{% static 'tinymce/tinymce.min.js' %}"></script>

{# --- JSON Data for Alpine --- #}
{{ all_categories_flat_list|json_script:"all-categories-data" }}
{{ group_to_categories_map|json_script:"group-categories-data" }}

{{ all_categories_list|json_script:"all-categories-list-data" }}
{{ all_suppliers_list|json_script:"all-suppliers-list-data" }}
{{ all_image_categories_json|json_script:"all-image-categories-data" }}
{{ all_user_groups_list|json_script:"all-user-groups-data" }}
{{ all_banners_list|json_script:"all-banners-data" }}

<script>
    document.addEventListener('alpine:init', () => {
        // --- 1. Global Store for Filters & Modal Data ---
        Alpine.store('globals', {
            allCategoriesFlat: JSON.parse(document.getElementById('all-categories-data').textContent),
            groupCategoriesMap: JSON.parse(document.getElementById('group-categories-data').textContent),

            allCategoriesList: JSON.parse(document.getElementById('all-categories-list-data').textContent),
            allSuppliersList: JSON.parse(document.getElementById('all-suppliers-list-data').textContent),
            allImageCategories: JSON.parse(document.getElementById('all-image-categories-data').textContent),
            allUserGroupsList: JSON.parse(document.getElementById('all-user-groups-data').textContent),
            allBanners: JSON.parse(document.getElementById('all-banners-data') ? document.getElementById('all-banners-data').textContent : '[]'),
            csrfToken: '',
            selectedCategoryId: null, // For image filter
            invoiceToOpen: null
        });

        // --- 2. Global Store for Image Management ---
        Alpine.store('images', {
            galleryImages: [],
            allProducts: [],
            allPosts: [],
            selectedImageToAssign: null,
            bulkSelectedImageIds: [],

            showAssignProductModal: false,
            assignProductModalSearchTerm: '',
            assignProductModalSelectedProducts: [],
            assignProductModalAssignmentType: 'featured',
            assignProductModalIsSubmitting: false,

            showAssignPostModal: false,
            assignPostModalSearchTerm: '',
            assignPostModalSelectedPosts: [],
            assignPostModalAssignmentType: 'featured',
            assignPostModalIsSubmitting: false,

            showBulkAssignModal: false,
            bulkAssignTargetType: 'product',
            bulkAssignSearchTerm: '',
            bulkAssignTargetId: null,
            bulkAssignIsSubmitting: false,

            showImageEditModal: false,
            isSubmittingImageEdit: false,
            currentImageToEdit: { id: null, title: '', alt_text: '', category_id: null, url: '' },

            // --- Getters ---
            get filteredImages() {
                if (Alpine.store('globals').selectedCategoryId === null) return this.galleryImages;
                return this.galleryImages.filter(img => img.category_id == Alpine.store('globals').selectedCategoryId);
            },
            get filteredProductsForModal() {
                if (!this.assignProductModalSearchTerm) return this.allProducts;
                const search = this.assignProductModalSearchTerm.toLowerCase();
                return this.allProducts.filter(p => p.name.toLowerCase().includes(search) || (p.sku && p.sku.toLowerCase().includes(search)));
            },
            get filteredPostsForModal() {
                if (!this.assignPostModalSearchTerm) return this.allPosts;
                const search = this.assignPostModalSearchTerm.toLowerCase();
                return this.allPosts.filter(p => p.title.toLowerCase().includes(search));
            },
            get filteredProductsForBulkAssign() {
                if (!this.bulkAssignSearchTerm) return this.allProducts;
                const search = this.bulkAssignSearchTerm.toLowerCase();
                return this.allProducts.filter(p => p.name.toLowerCase().includes(search) || (p.sku && p.sku.toLowerCase().includes(search)));
            },
            get filteredPostsForBulkAssign() {
                if (!this.bulkAssignSearchTerm) return this.allPosts;
                const search = this.bulkAssignSearchTerm.toLowerCase();
                return this.allPosts.filter(p => p.title.toLowerCase().includes(search));
            },

            // --- Methods ---
            async handleImageUpload(event) {
                const form = event.target;
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type=submit]');
                if (!form.querySelector('input[type=file]').files.length) return;
                submitButton.disabled = true;
                submitButton.textContent = 'Uploading...';
                try {
                    const response = await fetch(`{% url 'images:ajax_upload_image' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json' },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        data.images.forEach(img => this.galleryImages.unshift(img));
                        form.reset();
                        alert('Image(s) uploaded successfully!');
                    } else { throw new Error(data.errors || 'Upload failed'); }
                } catch (err) { alert('Upload error: ' + err.message); }
                finally { submitButton.disabled = false; submitButton.textContent = 'Upload Image(s)'; }
            },
            async deleteImage(imageId) {
                if (!confirm('Are you sure?')) return;
                try {
                    const response = await fetch(`/images/api/delete-image/${imageId}/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.galleryImages.splice(this.galleryImages.findIndex(img => img.id === imageId), 1);
                        alert(data.message);
                    } else { throw new Error(data.error || 'Failed to delete'); }
                } catch (err) { alert('Delete error: ' + err.message); }
            },
            openAssignProductModal(image) {
                this.selectedImageToAssign = image;
                this.assignProductModalSearchTerm = '';
                this.assignProductModalAssignmentType = 'featured';
                this.updateProductModalSelections();
                this.showAssignProductModal = true;
            },
            updateProductModalSelections() {
                if (!this.selectedImageToAssign) return;
                const imageId = this.selectedImageToAssign.id;
                if (this.assignProductModalAssignmentType === 'featured') {
                    this.assignProductModalSelectedProducts = this.allProducts
                        .filter(p => p.featured_image_id === imageId).map(p => p.id);
                } else {
                    this.assignProductModalSelectedProducts = this.allProducts
                        .filter(p => p.gallery_image_ids.includes(imageId)).map(p => p.id);
                }
            },
            async submitProductAssignment() {
                this.assignProductModalIsSubmitting = true;
                const payload = {
                    image_id: this.selectedImageToAssign.id,
                    product_ids: this.assignProductModalSelectedProducts,
                    assignment_type: this.assignProductModalAssignmentType
                };
                try {
                    const response = await fetch(`{% url 'images:ajax_assign_to_products' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json', 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.allProducts = data.all_products; // Update local state
                        this.showAssignProductModal = false;
                        alert('Product assignments updated!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else { throw new Error(data.error || 'Failed to save'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.assignProductModalIsSubmitting = false; }
            },
            openAssignPostModal(image) {
                this.selectedImageToAssign = image;
                this.assignPostModalSearchTerm = '';
                this.assignPostModalAssignmentType = 'featured';
                this.updatePostModalSelections();
                this.showAssignPostModal = true;
            },
            updatePostModalSelections() {
                if (!this.selectedImageToAssign) return;
                const imageId = this.selectedImageToAssign.id;
                if (this.assignPostModalAssignmentType === 'featured') {
                    this.assignPostModalSelectedPosts = this.allPosts
                        .filter(p => p.featured_image_id === imageId).map(p => p.id);
                } else {
                    this.assignPostModalSelectedPosts = this.allPosts
                        .filter(p => p.gallery_image_ids.includes(imageId)).map(p => p.id);
                }
            },
            async submitPostAssignment() {
                this.assignPostModalIsSubmitting = true;
                const payload = {
                    image_id: this.selectedImageToAssign.id,
                    post_ids: this.assignPostModalSelectedPosts,
                    assignment_type: this.assignPostModalAssignmentType
                };
                try {
                    const response = await fetch(`{% url 'images:ajax_assign_to_posts' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json', 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.allPosts = data.all_posts;
                        this.showAssignPostModal = false;
                        alert('Post assignments updated!');
                    } else { throw new Error(data.error || 'Failed to save'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.assignPostModalIsSubmitting = false; }
            },
            openBulkAssignModal() {
                if (this.bulkSelectedImageIds.length === 0) {
                    alert('Please select one or more images first.');
                    return;
                }
                this.bulkAssignTargetType = 'product';
                this.bulkAssignSearchTerm = '';
                this.bulkAssignTargetId = null;
                this.showBulkAssignModal = true;
            },
            async submitBulkAssignment() {
                if (this.bulkAssignIsSubmitting || !this.bulkAssignTargetId || this.bulkSelectedImageIds.length === 0) return;
                this.bulkAssignIsSubmitting = true;
                const payload = {
                    image_ids: this.bulkSelectedImageIds,
                    target_id: this.bulkAssignTargetId,
                    target_type: this.bulkAssignTargetType
                };
                try {
                    const response = await fetch(`{% url 'images:ajax_bulk_assign' %}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': Alpine.store('globals').csrfToken, 'Accept': 'application/json', 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.allProducts = data.all_products;
                        this.allPosts = data.all_posts;
                        this.showBulkAssignModal = false;
                        this.bulkSelectedImageIds = [];
                        alert('Images successfully assigned to gallery!');
                    } else { throw new Error(data.error || 'Failed to save'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.bulkAssignIsSubmitting = false; }
            },
            openImageEditModal(image) {
                this.currentImageToEdit = { ...image };
                this.isSubmittingImageEdit = false;
                this.showImageEditModal = true;
            },
            async submitImageEdit() {
                if (this.isSubmittingImageEdit) return;
                this.isSubmittingImageEdit = true;
                const payload = {
                    title: this.currentImageToEdit.title,
                    alt_text: this.currentImageToEdit.alt_text,
                    category_id: this.currentImageToEdit.category_id
                };
                try {
                    const response = await fetch(`/images/api/edit-image/${this.currentImageToEdit.id}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        const index = this.galleryImages.findIndex(img => img.id === data.image.id);
                        if (index > -1) { this.galleryImages[index] = data.image; }
                        this.showImageEditModal = false;
                        alert('Image updated successfully!');
                    } else { throw new Error(data.error || 'Failed to update image.'); }
                } catch (err) { alert('Error: ' + err.message); }
                finally { this.isSubmittingImageEdit = false; }
            }
        });

        // --- 3. Component Data for Manage Tools Root ---
        Alpine.data('manageTools', () => ({
            tab: window.location.hash || '#quotations',
            uploadQuotationModalOpen: false,
            createQuotationModalOpen: false,
            editModalOpen: false,
            uploadBatchModalOpen: false,
            receiveStockModalOpen: false,
            uploadProductModalOpen: false,

            showPricingModal: false,
            pricingIsSubmitting: false,
            pricingData: {
                id: null,
                name: '',
                base_cost: null,
                profit_margin: null,
                selling_price: null,
                update_url: ''
            },

            // --- Banner State ---
            showBannerModal: false,
            bannerIsSubmitting: false,
            currentBanner: {
                id: null, location: 'HOME_HERO', title: '', subtitle: '',
                background_color: '#312E81', background_opacity: 90,
                content_position: 'center-middle',
                button_text: '', button_link: '', order: 0, is_active: true, background_image_url: ''
            },

            openBannerModal(banner = null) {
                if (banner) {
                    this.currentBanner = { ...banner };
                    if (this.currentBanner.background_opacity === undefined) this.currentBanner.background_opacity = 90;
                    if (!this.currentBanner.background_color) this.currentBanner.background_color = '#312E81';
                } else {
                    this.currentBanner = {
                        id: null, location: 'HOME_HERO', title: '', subtitle: '',
                        background_color: '#312E81', background_opacity: 90,
                        content_position: 'center-middle',
                        button_text: '', button_link: '', order: 0, is_active: true, background_image_url: ''
                    };
                }
                this.showBannerModal = true;
            },

            async submitBanner() {
                this.bannerIsSubmitting = true;
                const form = document.getElementById('banner-form');
                const formData = new FormData(form);

                if(!form.querySelector('[name=is_active]').checked) {
                    formData.set('is_active', 'False');
                } else {
                    formData.set('is_active', 'True');
                }

                let url = '{% url "api_save_banner" %}';
                if (this.currentBanner.id) {
                    url = `/manage/api/save-banner/${this.currentBanner.id}/`;
                }

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'X-CSRFToken': Alpine.store('globals').csrfToken},
                        body: formData
                    });
                    const data = await response.json();
                    if(data.success) {
                    alert('Banner saved!');
                    window.location.reload();
                    } else {
                    alert('Error saving banner');
                    }
                } catch(e) { console.error(e); }
                finally { this.bannerIsSubmitting = false; }
            },

            async deleteBanner(id) {
                if(!confirm('Delete this banner?')) return;
                try {
                    const response = await fetch(`/manage/api/delete-banner/${id}/`, {
                        method: 'POST',
                        headers: {'X-CSRFToken': Alpine.store('globals').csrfToken}
                    });
                    if(response.ok) window.location.reload();
                } catch(e) { console.error(e); }
            },

            // --- SEO Modal State ---
            showSeoModal: false,
            seoIsLoading: false,
            seoIsSubmitting: false,
            seoFormData: {
                id: null,
                page_name: '',
                page_path: '',
                meta_title: '',
                meta_description: '',
                update_url: ''
            },
            seoFormErrors: {},

            async openSeoModal(seoId = null) {
                this.seoFormErrors = {};
                this.showSeoModal = true;

                // Check if seoId is actually an event object or non-primitive
                if (typeof seoId === 'object') seoId = null;

                if (seoId) {
                    this.seoIsLoading = true;
                    try {
                        const response = await fetch(`/seo/manage/edit/${seoId}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch SEO data');
                        this.seoFormData = await response.json();
                    } catch (e) {
                        alert('Error loading data: ' + e.message);
                        this.showSeoModal = false;
                    } finally {
                        this.seoIsLoading = false;
                    }
                } else {
                    this.seoIsLoading = false;
                    this.seoFormData = {
                        id: null,
                        page_name: '',
                        page_path: '',
                        meta_title: '',
                        meta_description: '',
                        update_url: '{% url "seo:manage_seo_create" %}'
                    };
                }
            },

            async submitSeoForm() {
                if (this.seoIsSubmitting) return;
                this.seoIsSubmitting = true;
                this.seoFormErrors = {};

                try {
                    const response = await fetch(this.seoFormData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(this.seoFormData)
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(data.message || 'Saved successfully!');
                        window.location.reload();
                    } else {
                        this.seoFormErrors = data.errors || { '__all__': [data.error || 'An unknown error occurred'] };
                    }
                } catch (e) {
                    this.seoFormErrors = { '__all__': ['Network error: ' + e.message] };
                } finally {
                    this.seoIsSubmitting = false;
                }
            },

            // --- Category Modal State ---
            showCategoryModal: false,
            categoryIsLoading: false,
            categoryIsSubmitting: false,
            categoryFormData: {
                id: null,
                name: '',
                page_title: '',
                description: '',
                sections: [],
                update_url: ''
            },
            categoryFormErrors: {},

            // Category Gallery State
            catShowGallery: false,
            catGalleryLoading: false,
            catGalleryImages: [],
            catActiveEditorId: null,

            async openCategoryModal(catId = null) {
                // FIXED: Ensure catId is null if it's an event object (clicked Add button)
                if (typeof catId === 'object') catId = null;

                this.categoryFormErrors = {};
                this.showCategoryModal = true;
                this.categoryIsLoading = true;

                if (catId) {
                    try {
                        const response = await fetch(`/manage/category/edit/${catId}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch data');
                        const data = await response.json();
                        // Assign unique IDs to existing sections to fix index-based bugs
                        if (data.sections) {
                            data.sections = data.sections.map(s => ({...s, uid: Date.now() + Math.random().toString(36).substr(2, 9)}));
                        }
                        this.categoryFormData = data;
                    } catch (e) {
                        alert(e.message);
                        this.showCategoryModal = false;
                    }
                } else {
                    this.categoryFormData = {
                        id: null,
                        name: '',
                        page_title: '',
                        description: '',
                        sections: [],
                        update_url: '{% url "product:manage_category_create" %}'
                    };
                }

                this.categoryIsLoading = false;

                // Initialize TinyMCE after DOM update
                this.$nextTick(() => {
                    this.initCatTinyMCE('cat-desc-editor', null);
                    this.categoryFormData.sections.forEach((section) => {
                        this.initCatTinyMCE('cat-section-' + section.uid, section.uid);
                    });
                });
            },

            closeCategoryModal() {
                if (this.catShowGallery) {
                    this.catShowGallery = false;
                    return;
                }
                if (confirm('Are you sure you want to close? Unsaved changes will be lost.')) {
                    if (typeof tinymce !== 'undefined') {
                        tinymce.remove('#cat-desc-editor');
                        this.categoryFormData.sections.forEach((section) => {
                            tinymce.remove('#cat-section-' + section.uid);
                        });
                    }
                    this.showCategoryModal = false;
                }
            },

            initCatTinyMCE(elementId, sectionUid) {
                if (typeof tinymce === 'undefined') return;

                // Ensure existing instance is removed
                if (tinymce.get(elementId)) tinymce.remove('#' + elementId);

                tinymce.init({
                    selector: '#' + elementId,
                    height: 300,
                    menubar: false,
                    plugins: 'lists link image code table',
                    toolbar: 'undo redo | bold italic | bullist numlist | link image | code',
                    setup: (editor) => {
                        editor.on('init', () => {
                            if (sectionUid === null) {
                                editor.setContent(this.categoryFormData.description || '');
                            } else {
                                // Find section by UID
                                const section = this.categoryFormData.sections.find(s => s.uid === sectionUid);
                                if (section) editor.setContent(section.content || '');
                            }
                        });
                        editor.on('change keyup', () => {
                            const content = editor.getContent();
                            if (sectionUid === null) {
                                this.categoryFormData.description = content;
                            } else {
                                const section = this.categoryFormData.sections.find(s => s.uid === sectionUid);
                                if (section) section.content = content;
                            }
                        });
                    }
                });
            },

            addCategorySection() {
                const newUid = Date.now() + Math.random().toString(36).substr(2, 9);
                this.categoryFormData.sections.push({title: '', content: '', uid: newUid});
                this.$nextTick(() => {
                    this.initCatTinyMCE('cat-section-' + newUid, newUid);
                });
            },

            removeCategorySection(uid) {
                if (confirm('Remove section?')) {
                    // Find index using UID
                    const index = this.categoryFormData.sections.findIndex(s => s.uid === uid);
                    if (index > -1) {
                        tinymce.remove('#cat-section-' + uid);
                        this.categoryFormData.sections.splice(index, 1);
                    }
                }
            },

            async openCatGallery(editorId) {
                this.catActiveEditorId = editorId;
                this.catShowGallery = true;
                if (this.catGalleryImages.length === 0) {
                    this.catGalleryLoading = true;
                    try {
                        const res = await fetch("{% url 'images:ajax_get_images' %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
                        const data = await res.json();
                        this.catGalleryImages = data.images;
                    } catch(e) { console.error(e); }
                    finally { this.catGalleryLoading = false; }
                }
            },

            insertCatImage(url, alt) {
                const imgTag = `<img src="${url}" alt="${alt}" style="max-width:100%;" />`;
                const editor = tinymce.get(this.catActiveEditorId);
                if (editor) {
                    // FIXED: Focus the editor first to prevent 'getRng' errors
                    editor.focus();
                    editor.insertContent(imgTag);
                }
                this.catShowGallery = false;
            },

            async submitCategoryForm() {
                this.categoryIsSubmitting = true;
                this.categoryFormErrors = {};

                if (typeof tinymce !== 'undefined') tinymce.triggerSave();

                // Manual sync check for main description
                if (tinymce.get('cat-desc-editor')) {
                    this.categoryFormData.description = tinymce.get('cat-desc-editor').getContent();
                }

                // Manual sync check for sections
                this.categoryFormData.sections.forEach((section) => {
                    const editor = tinymce.get('cat-section-' + section.uid);
                    if (editor) {
                        section.content = editor.getContent();
                    }
                });

                try {
                    const res = await fetch(this.categoryFormData.update_url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(this.categoryFormData)
                    });
                    const data = await res.json();
                    if (res.ok && data.success) {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        this.categoryFormErrors = data.errors || {'__all__': [data.error]};
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                } finally {
                    this.categoryIsSubmitting = false;
                }
            },

            // --- State for Modals (Managed by parent) ---
            receiveStockData: {
                invoiceItemId: '', invoiceId: '', productId: '', productName: '',
                productSku: '', supplierId: '', supplierName: '',
                quotationId: '', batch_number: '',
                received_date: '{{ today_date|date:"Y-m-d" }}', expiry_date: '',
                quantity_to_receive: '',
                max_receivable: ''
            },
            currentInvoice: {
                invoice_id: '', status: '', payment_date: '', notes: '', update_url: ''
            },

            // --- State for Product Edit Modal (Managed by parent) ---
            showProductEditModal: false,
            productEditIsLoading: false,
            productEditIsSubmitting: false,
            productEditData: {
                id: null, name: '', sku: '', description: '', members_only: false,
                is_featured: false, categories: [], suppliers: [], featured_image: null,
                gallery_images: [], update_url: '', selectedImageUrl: ''
            },
            productEditErrors: {},


            get selectedGalleryImages() {
                if (!this.productEditData.id) return [];
                return Alpine.store('images').galleryImages.filter(image =>
                    this.productEditData.gallery_images.includes(image.id)
                );
            },

            get pricingProfit() {
                const cost = this.pricingData.base_cost;
                const price = this.pricingData.selling_price;
                if (cost === null || cost === undefined || price === null || price === undefined) {
                    return null;
                }
                const profit = parseFloat(price) - parseFloat(cost);
                return profit > 0 ? profit : null;
            },

            // --- Blog Modal State ---
            showBlogModal: false,
            blogIsLoading: false,
            blogIsSubmitting: false,
            blogProductSearch: '',
            blogFormData: {
                id: null, title: '', slug: '', content: '',
                post_type: 'NEWS', is_published: true,
                featured_image: null, featured_image_url: '',
                user_groups: [], related_products: [],
                related_products_title: ''
            },
            blogFormErrors: {},

            // Blog Gallery State (for inserting images into content)
            blogShowGallery: false,
            blogGalleryLoading: false,
            blogGalleryImages: [],
            blogGalleryMode: 'content', // 'content' or 'featured'

            async openBlogModal(postId = null) {
                if(typeof postId === 'object') postId = null; // Fix event obj

                this.blogFormErrors = {};
                this.blogProductSearch = '';
                this.showBlogModal = true;

                if (postId) {
                    this.blogIsLoading = true;
                    try {
                        const res = await fetch(`/blog/api/get-details/${postId}/`, {
                             headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        });
                        const data = await res.json();
                        this.blogFormData = data;
                    } catch(e) {
                        alert('Error loading post: ' + e.message);
                        this.showBlogModal = false;
                    } finally {
                        this.blogIsLoading = false;
                    }
                } else {
                    // Reset
                    this.blogFormData = {
                        id: null, title: '', slug: '', content: '',
                        post_type: 'NEWS', is_published: true,
                        featured_image: null, featured_image_url: '',
                        user_groups: [], related_products: [],
                        related_products_title: 'Related Products'
                    };
                }

                // Init TinyMCE
                this.$nextTick(() => {
                    this.initBlogTinyMCE();
                });
            },

            closeBlogModal() {
                if(confirm('Unsaved changes will be lost. Close?')) {
                    if (typeof tinymce !== 'undefined') tinymce.remove('#blog-content-editor');
                    this.showBlogModal = false;
                }
            },

            initBlogTinyMCE() {
                if (typeof tinymce === 'undefined') return;
                if (tinymce.get('blog-content-editor')) tinymce.remove('#blog-content-editor');

                tinymce.init({
                    selector: '#blog-content-editor',
                    height: 400,
                    menubar: false,
                    plugins: 'lists link image code table wordcount',
                    toolbar: 'undo redo | bold italic | bullist numlist | link | code',
                    setup: (editor) => {
                        editor.on('init', () => {
                            editor.setContent(this.blogFormData.content || '');
                        });
                        editor.on('change keyup', () => {
                            this.blogFormData.content = editor.getContent();
                        });
                    }
                });
            },

            // Blog Gallery Logic
            async openBlogGallery(editorId) {
                this.blogGalleryMode = 'content';
                this.blogShowGallery = true;
                await this.loadBlogGalleryImages();
            },

            openBlogGalleryForFeatured() {
                this.blogGalleryMode = 'featured';
                this.blogShowGallery = true;
                this.loadBlogGalleryImages();
            },

            async loadBlogGalleryImages() {
                 if (this.blogGalleryImages.length === 0) {
                    this.blogGalleryLoading = true;
                    try {
                        const res = await fetch("{% url 'images:ajax_get_images' %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
                        const data = await res.json();
                        this.blogGalleryImages = data.images;
                    } catch(e) { console.error(e); }
                    finally { this.blogGalleryLoading = false; }
                }
            },

            insertBlogImage(img) {
                if (this.blogGalleryMode === 'featured') {
                    this.blogFormData.featured_image = img.id;
                    this.blogFormData.featured_image_url = img.url;
                } else {
                    // Insert into Editor
                    const html = `<img src="${img.url}" alt="${img.alt_text}" style="max-width:100%; height:auto;" class="my-4 rounded-lg shadow-sm"/>`;
                    const editor = tinymce.get('blog-content-editor');
                    if (editor) editor.insertContent(html);
                }
                this.blogShowGallery = false;
            },

            async submitBlogForm() {
                if(this.blogIsSubmitting) return;
                this.blogIsSubmitting = true;
                this.blogFormErrors = {};

                if (typeof tinymce !== 'undefined' && tinymce.get('blog-content-editor')) {
                    this.blogFormData.content = tinymce.get('blog-content-editor').getContent();
                }

                const url = this.blogFormData.id
                    ? `/blog/api/save/${this.blogFormData.id}/`
                    : `/blog/api/save/`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(this.blogFormData)
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        this.blogFormErrors = data.errors || {'__all__': [data.error]};
                    }
                } catch(e) {
                    alert('Network error: ' + e.message);
                } finally {
                    this.blogIsSubmitting = false;
                }
            },

            // --- INIT ---
            init() {
                const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (tokenInput) {
                    Alpine.store('globals').csrfToken = tokenInput.value;
                } else {
                    console.error('CSRF token not found on page.');
                }

                // Watch for tab changes and scroll to top
                this.$watch('tab', (val) => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                // Ensure Back/Forward button updates the tab correctly
                window.addEventListener('hashchange', () => {
                    this.tab = window.location.hash || '#quotations';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            },

            // --- Modal Functions (Live in parent) ---
            async fetchInvoiceData(invoiceId) {
                try {
                    const url = `/sales/invoice/${invoiceId}/edit/`;
                    const response = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    if (!response.ok) { throw new Error(`Network response error (${response.status})`); }
                    this.currentInvoice = await response.json();
                    this.editModalOpen = true;
                } catch (error) {
                    console.error('Fetch invoice data error:', error);
                    alert('Could not load invoice details.');
                }
            },
            async submitInvoiceUpdate() {
                const form = document.getElementById('edit-invoice-form'); if (!form) return;
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type=submit]');
                submitButton.disabled = true; submitButton.innerHTML = 'Saving...';
                try {
                    const response = await fetch(this.currentInvoice.update_url, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': Alpine.store('globals').csrfToken },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.editModalOpen = false;
                        alert('Invoice updated successfully!');
                        alert('Page will now refresh to show invoice status update.');
                        window.location.reload();
                    } else {
                        let errorMsg = 'Update failed:\n' + (data.error || '');
                        if (data.errors) {
                            for (const field in data.errors) {
                                errorMsg += `- ${field}: ${data.errors[field].join(', ')}\n`;
                            }
                        }
                        alert(errorMsg);
                    }
                } catch (error) {
                    alert('Network error during update.');
                } finally {
                    submitButton.disabled = false; submitButton.innerHTML = 'Save Changes';
                }
            },
            openReceiveStockModal(data) {
                if (!this.receiveStockModalOpen) {
                    this.receiveStockData.received_date = '{{ today_date|date:"Y-m-d" }}';
                    this.receiveStockData.batch_number = '';
                    this.receiveStockData.expiry_date = '';
                }
                this.receiveStockData = {
                    ...this.receiveStockData,
                    ...data,
                    quantity_to_receive: data.quantity,
                    max_receivable: data.quantity
                };
                this.receiveStockModalOpen = true;
            },
            closeReceiveStockModal() { this.receiveStockModalOpen = false; },

            openPricingModal(product) {
                const baseCost = product.base_cost ? parseFloat(product.base_cost) : null;
                let profitMargin = product.profit_margin ? parseFloat(product.profit_margin) : null;
                let sellingPrice = product.selling_price ? parseFloat(product.selling_price) : null;

                if (baseCost !== null) {
                    if (sellingPrice !== null && profitMargin === null) {
                        if (sellingPrice > 0) {
                            profitMargin = ((parseFloat(sellingPrice) - parseFloat(baseCost)) / parseFloat(sellingPrice)) * 100;
                        }
                    } else if (sellingPrice === null && profitMargin !== null) {
                        const marginDecimal = parseFloat(profitMargin) / 100;
                        if (marginDecimal < 1) {
                            sellingPrice = baseCost / (1 - marginDecimal);
                        }
                    }
                }

                this.pricingData = {
                    id: product.id,
                    name: product.name,
                    base_cost: baseCost,
                    profit_margin: profitMargin !== null ? Math.round(profitMargin) : null,
                    selling_price: sellingPrice ? parseFloat(sellingPrice.toFixed(2)) : null,
                    is_promotion: product.is_promotion || false,
                    promotion_rate: product.promotion_rate ? parseFloat(product.promotion_rate) : null,
                    update_url: `/api/manage-pricing/${product.id}/`
                };
                this.showPricingModal = true;
            },

            calculatePriceFromMargin() {
                const cost = this.pricingData.base_cost;
                const margin = this.pricingData.profit_margin;
                if (cost === null || cost === undefined || margin === null || margin === undefined) {
                    this.pricingData.selling_price = null;
                    return;
                }
                const marginDecimal = parseFloat(margin) / 100;
                if (marginDecimal >= 1) {
                    this.pricingData.selling_price = null;
                    return;
                }
                const price = parseFloat(cost) / (1 - marginDecimal);
                this.pricingData.selling_price = parseFloat(price.toFixed(2));
            },

            calculateMarginFromPrice() {
                const cost = this.pricingData.base_cost;
                const price = this.pricingData.selling_price;
                if (cost === null || cost === undefined || price === null || price === undefined || price === 0) {
                    this.pricingData.profit_margin = null;
                    return;
                }
                const margin = ((parseFloat(price) - parseFloat(cost)) / parseFloat(price)) * 100;
                this.pricingData.profit_margin = Math.round(margin);
            },

            async submitPricingUpdate() {
                if (this.pricingIsSubmitting) return;
                this.pricingIsSubmitting = true;

                const payload = {
                    profit_margin: this.pricingData.profit_margin,
                    selling_price: this.pricingData.selling_price,
                    is_promotion: this.pricingData.is_promotion,
                    promotion_rate: this.pricingData.promotion_rate
                };

                try {
                    const response = await fetch(this.pricingData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.showPricingModal = false;
                        alert('Pricing updated successfully!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else {
                        alert('Error updating pricing: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('A network error occurred: ' + err.message);
                } finally {
                    this.pricingIsSubmitting = false;
                }
            },

            async openProductEditModal(productId) {
                this.productEditIsLoading = true;
                this.showProductEditModal = true;
                this.productEditErrors = {};

                try {
                    const url = `/manage/edit/${productId}/`;
                    const response = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    if (!response.ok) { throw new Error('Failed to load product data.'); }

                    const data = await response.json();
                    this.productEditData = data;
                } catch (err) {
                    this.productEditErrors = { '__all__': [err.message || 'Could not load data.'] };
                } finally {
                    this.productEditIsLoading = false;
                }
            },

            async submitProductEdit() {
                this.productEditIsSubmitting = true;
                this.productEditErrors = {};
                const formData = new FormData();
                formData.append('name', this.productEditData.name);
                formData.append('sku', this.productEditData.sku || '');
                formData.append('description_title', this.productEditData.description_title || '');
                formData.append('description', this.productEditData.description || '');

                if (this.productEditData.sections) {
                    formData.append('sections_data', JSON.stringify(this.productEditData.sections));
                }

                if (this.productEditData.members_only) {
                    formData.append('members_only', 'on');
                }

                if (this.productEditData.is_featured) {
                    formData.append('is_featured', 'on');
                }

                if (this.productEditData.featured_image) {
                    formData.append('featured_image', this.productEditData.featured_image);
                } else {
                    formData.append('featured_image', '');
                }

                this.productEditData.categories.forEach(id => formData.append('categories', id));
                this.productEditData.suppliers.forEach(id => formData.append('suppliers', id));
                this.productEditData.gallery_images.forEach(id => formData.append('gallery_images', id));

                try {
                    const response = await fetch(this.productEditData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json'
                        },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.showProductEditModal = false;
                        alert('Product updated successfully!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else {
                        this.productEditErrors = data.errors || { '__all__': ['An unknown error occurred.'] };
                    }
                } catch (err) {
                    this.productEditErrors = { '__all__': [err.message || 'A network error occurred.'] };
                } finally {
                    this.productEditIsSubmitting = false;
                }
            },

            removeImageFromProductGallery(imageId) {
                if (!this.productEditData || !this.productEditData.gallery_images) return;
                this.productEditData.gallery_images = this.productEditData.gallery_images.filter(id => id !== imageId);
            },

            // --- Image Gallery Modal Functions (Passthrough to store) ---
            handleImageUpload(event) { Alpine.store('images').handleImageUpload(event); },
            deleteImage(id) { Alpine.store('images').deleteImage(id); },
            openAssignProductModal(image) { Alpine.store('images').openAssignProductModal(image); },
            openAssignPostModal(image) { Alpine.store('images').openAssignPostModal(image); },
            openBulkAssignModal() { Alpine.store('images').openBulkAssignModal(); },
            submitProductAssignment() { Alpine.store('images').submitProductAssignment(); },
            submitPostAssignment() { Alpine.store('images').submitPostAssignment(); },
            submitBulkAssignment() { Alpine.store('images').submitBulkAssignment(); },
            updateProductModalSelections() { Alpine.store('images').updateProductModalSelections(); },
            updatePostModalSelections() { Alpine.store('images').updatePostModalSelections(); },

            // --- Getters for Image Modals (Bound to store) ---
            get filteredImages() { return Alpine.store('images').filteredImages; },
            get filteredProductsForModal() { return Alpine.store('images').filteredProductsForModal; },
            get filteredPostsForModal() { return Alpine.store('images').filteredPostsForModal; },
            get filteredProductsForBulkAssign() { return Alpine.store('images').filteredProductsForBulkAssign; },
            get filteredPostsForBulkAssign() { return Alpine.store('images').filteredPostsForBulkAssign; }

        }));

        Alpine.data('productAccordionRow', (productId) => ({
            id: productId,
            open: false,
            batches: [],
            isLoading: false,
            hasLoaded: false,
            async toggle() {
                this.open = !this.open;
                if (this.open && !this.hasLoaded) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/inventory/api/product-batches/${this.id}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch batch data.');
                        const data = await response.json();
                        this.batches = data.batches;
                        this.hasLoaded = true;
                    } catch (error) { console.error(`Failed to load batches for product ${this.id}:`, error); }
                    finally { this.isLoading = false; }
                }
            }
        }));

        Alpine.data('quotationAccordionRow', (quotationId) => ({
            id: quotationId,
            open: false,
            items: [],
            isLoading: false,
            hasLoaded: false,
            async toggle() {
                this.open = !this.open;
                if (this.open && !this.hasLoaded) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/inventory/api/quotation-items/${this.id}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch quotation items.');
                        const data = await response.json();
                        this.items = data.items;
                        this.hasLoaded = true;
                    } catch (error) { console.error(`Failed to load items for quotation ${this.id}:`, error); }
                    finally { this.isLoading = false; }
                }
            }
        }));

        Alpine.data('productTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            filterGroup: '',
            filterCategory: '',
            allCategories: [],
            groupCategoriesMap: {},
            init() {
                this.allCategories = Alpine.store('globals').allCategoriesFlat;
                this.groupCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                this.fetchProducts(1);
            },
            get availableCategories() {
                if (!this.filterGroup) return this.allCategories;
                const globalCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                if (globalCategoriesMap && globalCategoriesMap[this.filterGroup]) {
                    return globalCategoriesMap[this.filterGroup] || [];
                }
                return [];
            },
            async fetchProducts(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText, group: this.filterGroup, category: this.filterCategory });
                try {
                    const response = await fetch(`{% url 'product:api_manage_products' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch products:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() {
                this.filterText = ''; this.filterGroup = ''; this.filterCategory = '';
                this.fetchProducts(1);
            },
            setGroupFilter(groupName) {
                this.filterGroup = groupName;
                this.filterCategory = '';
                this.fetchProducts(1);
            },
            setCategoryFilter(categoryName) {
                this.filterCategory = categoryName;
                this.fetchProducts(1);
            },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('inventoryTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            filterGroup: '',
            filterCategory: '',
            allCategories: [],
            groupCategoriesMap: {},
            init() {
                this.allCategories = Alpine.store('globals').allCategoriesFlat;
                this.groupCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                this.fetchInventory(1);
            },
            get availableCategories() {
                if (!this.filterGroup) return this.allCategories;
                const globalCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                if (globalCategoriesMap && globalCategoriesMap[this.filterGroup]) {
                    return globalCategoriesMap[this.filterGroup] || [];
                }
                return [];
            },
            async fetchInventory(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText, group: this.filterGroup, category: this.filterCategory });
                try {
                    const response = await fetch(`{% url 'inventory:api_manage_inventory' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch inventory:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() {
                this.filterText = ''; this.filterGroup = ''; this.filterCategory = ''; this.fetchInventory(1);
            },
            setGroupFilter(groupName) {
                this.filterGroup = groupName; this.filterCategory = ''; this.fetchInventory(1);
            },
            setCategoryFilter(categoryName) {
                this.filterCategory = categoryName;
                this.fetchInventory(1);
            },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('quotationsTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            init() { this.fetchQuotations(1); },
            async fetchQuotations(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText });
                try {
                    const response = await fetch(`{% url 'inventory:api_manage_quotations' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch quotations:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() { this.filterText = ''; this.fetchQuotations(1); },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('imageTabManager', () => ({
            isLoading: true,
            init() {
                if (Alpine.store('images').galleryImages.length > 0) {
                    this.isLoading = false;
                    return; // Already loaded
                }
                this.fetchInitialImageData();
            },
            async fetchInitialImageData() {
                this.isLoading = true;
                const apiHeaders = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
                try {
                    const [imagesRes, productsRes, postsRes] = await Promise.all([
                        fetch(`{% url 'images:ajax_get_images' %}`, { headers: apiHeaders }),
                        fetch(`{% url 'product:api_manage_products' %}?page=1&limit=10000`, { headers: apiHeaders }),
                        fetch(`{% url 'blog:api_manage_posts' %}?page=1&limit=10000`, { headers: apiHeaders })
                    ]);

                    if (!imagesRes.ok || !productsRes.ok || !postsRes.ok) {
                        throw new Error('One or more API requests failed');
                    }
                    const imagesData = await imagesRes.json();
                    const productsData = await productsRes.json();
                    const postsData = await postsRes.json();
                    Alpine.store('images').galleryImages = imagesData.images;
                    Alpine.store('images').allProducts = productsData.items;
                    Alpine.store('images').allPosts = postsData.items;
                    Alpine.store('globals').allImageCategories = imagesData.categories;
                } catch (error) {
                    console.error('Failed to load initial image data:', error);
                    alert('Could not load image gallery data.');
                } finally {
                    this.isLoading = false;
                }
            }
        }));
    });
</script>


<div id="manage-tools-root" class="w-full max-w-6xl mx-auto" x-data="manageTools"
@open-product-edit-modal.window="openProductEditModal($event.detail)"
@open-upload-quotation-modal.window="uploadQuotationModalOpen = true"
@open-create-quotation-modal.window="createQuotationModalOpen = true"
@open-upload-batch-modal.window="uploadBatchModalOpen = true"
@open-pricing-modal.window="openPricingModal($event.detail)"
@open-upload-product-modal.window="uploadProductModalOpen = true"

@open-seo-modal.window="openSeoModal($event.detail)"
@open-category-modal.window="openCategoryModal($event.detail)"

@close-receive-modal.window="closeReceiveStockModal()"
@images-open-edit.window="Alpine.store('images').openImageEditModal($event.detail)"

@images-handle-upload.window="Alpine.store('images').handleImageUpload($event)"
@images-delete.window="Alpine.store('images').deleteImage($event.detail)"
@images-open-assign-product.window="Alpine.store('images').openAssignProductModal($event.detail)"
@images-open-assign-post.window="Alpine.store('images').openAssignPostModal($event.detail)"
@images-open-bulk-assign.window="Alpine.store('images').openBulkAssignModal()"
@images-submit-product-assign.window="Alpine.store('images').submitProductAssignment()"
@images-submit-post-assign.window="Alpine.store('images').submitPostAssignment()"
@images-submit-bulk-assign.window="Alpine.store('images').submitBulkAssignment()"
@images-update-product-selections.window="Alpine.store('images').updateProductModalSelections()"
@images-update-post-selections.window="Alpine.store('images').updatePostModalSelections()"
>

    {% if messages %}
    <div class="mb-4 space-y-2">
        {% for message in messages %}
         <div class="px-4 py-3 rounded relative
            {% if message.tags == 'success' %} bg-green-100 border border-green-400 text-green-700
            {% elif message.tags == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-700
            {% elif message.tags == 'error' %} bg-red-100 border border-red-400 text-red-700
            {% else %} bg-blue-100 border border-blue-400 text-blue-700
            {% endif %}" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# --- The Tabs --- #}
    {% include 'core/partials/manage_tabs.html' %}

    {# --- Tab Content --- #}
    <div class="pt-8">
        <div x-show="tab === '#quotations'" id="quotations" x-cloak>
             {% include 'inventory/partials/quotations_tab.html' %}
        </div>

        <div x-show="tab === '#invoices'" id="invoices" x-cloak>
            {% include 'inventory/partials/invoices_tab.html' %}
        </div>

        <div x-show="tab === '#inventory'" id="inventory" x-cloak>
             {% include 'inventory/partials/inventory_tab.html' %}
        </div>

        <div x-show="tab === '#products'" id="products" x-cloak>
             {% include 'product/manage_products_tab.html' %}
        </div>

        <div x-show="tab === '#categories'" id="categories" x-cloak>
            {% include 'product/manage_categories_tab.html' %}
        </div>

        <div x-show="tab === '#blog'" id="blog" x-cloak>
             {% include 'blog/manage_blog_tab.html' %}
        </div>

        <div x-show="tab === '#seo'" id="seo" x-cloak>
             {% include 'seo/manage_seo_tab.html' %}
        </div>

        <div x-show="tab === '#images'" id="images" x-cloak>
             {% include 'images/manage_images_tab.html' %}
        </div>

        <div x-show="tab === '#agents'" id="agents" x-cloak>
             {% include 'user/manage_agents_tab.html' %}
        </div>

        <div x-show="tab === '#banners'" id="banners" x-cloak>
             {% include 'core/partials/manage_banners_tab.html' %}
        </div>

        <div x-show="tab === '#commissions'" id="commissions" x-cloak>
             {% include 'commission/manage_commissions_tab.html' %}
        </div>

        <div x-show="tab === '#orders'" id="orders" x-cloak>
             <div class="bg-white shadow sm:rounded-lg p-6 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Order Management</h3>
                <p class="mt-2 max-w-xl text-sm text-gray-500 mx-auto">
                    Manage agent orders, view statistics, and update statuses in the dedicated panel.
                </p>
                <div class="mt-5">
                    <a href="{% url 'order:manage_orders' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Open Order Management Panel &rarr;
                    </a>
                </div>
             </div>
        </div>
    </div>

    {# --- All Modals --- #}
    {% include 'inventory/partials/upload_quotation_modal.html' %}
    {% include 'inventory/partials/create_quotation_modal.html' %}
    {% include 'inventory/partials/edit_invoice_modal.html' %}
    {% include 'inventory/partials/upload_batch_modal.html' %}
    {% include 'inventory/partials/receive_stock_modal.html' %}
    <div x-show="$store.images.showAssignProductModal">
        {% include 'images/partials/assign_product_modal.html' %}
    </div>
    <div x-show="$store.images.showAssignPostModal">
        {% include 'images/partials/assign_post_modal.html' %}
    </div>
    <div x-show="$store.images.showBulkAssignModal">
        {% include 'images/partials/bulk_assign_modal.html' %}
    </div>
    {% include 'product/partials/product_edit_modal.html' %}
    {% include 'product/product_pricing_modal.html' %}
    {% include 'product/partials/upload_product_modal.html' %}
    <div x-show="$store.images.showImageEditModal">
        {% include 'images/partials/edit_image_modal.html' %}
    </div>
    {% include 'core/partials/edit_banner_modal.html' %}
    {% include 'seo/partials/manage_seo_modal.html' %}
    {% include 'product/partials/manage_category_modal.html' %}
    {% include 'blog/partials/manage_blog_modal.html' %}
</div>

{# --- JavaScript for Receive Stock AJAX Submission (Unchanged) --- #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const receiveStockForm = document.getElementById('receive-stock-form');
    if (receiveStockForm) {
        const errorContainer = document.getElementById('receive-stock-error-container');
        const errorMessage = document.getElementById('receive-stock-error-message');

        receiveStockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Get the token from the main Alpine STORE
            const csrfToken = Alpine.store('globals').csrfToken;
            const formData = new FormData(receiveStockForm);
            const submitButton = receiveStockForm.querySelector('button[type=submit]');
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            errorContainer.classList.add('hidden');

            try {
                const response = await fetch(receiveStockForm.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    // Find the main Alpine component's root DOM node
                    const rootComponent = document.getElementById('manage-tools-root'); // This ID now exists
                    if (rootComponent && rootComponent.__x) {
                        const rootData = rootComponent.__x.data; // Access Alpine's data
                        const fullInvoiceId = rootData.receiveStockData.invoiceId;

                        alert('Stock received successfully! The page will refresh to show updated data.');

                        if (fullInvoiceId) {
                            const newUrl = window.location.origin + window.location.pathname + '#invoices?open=' + fullInvoiceId;
                            window.location.href = newUrl;
                        } else {
                            window.location.reload();
                        }
                    } else {
                        // Fallback if the root element isn't found
                        alert('Stock received successfully! Reloading page.');
                        window.location.reload();
                    }
                } else {
                    let errorText = data.error || (data.errors ? JSON.stringify(data.errors) : 'An error occurred.');
                    errorMessage.textContent = errorText;
                    errorContainer.classList.remove('hidden');
                }
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}.`;
                errorContainer.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Confirm Stock Received';
            }
        });
    }

});
</script>
{% endblock %}

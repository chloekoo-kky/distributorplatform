<script>
    document.addEventListener('alpine:init', () => {
        // --- 1. Root Component for Manage Dashboard ---
        Alpine.data('manageTools', () => ({
            // --- State ---
            tab: window.location.hash || '#quotations',

            // Simple Modal Flags
            uploadQuotationModalOpen: false,
            createQuotationModalOpen: false,
            editModalOpen: false, // For Edit Invoice Modal
            uploadBatchModalOpen: false,
            receiveStockModalOpen: false,
            uploadProductModalOpen: false,

            // Pricing Modal State
            showPricingModal: false,
            pricingIsSubmitting: false,
            pricingData: {
                id: null, name: '', base_cost: null, profit_margin: null,
                selling_price: null, is_promotion: false, promotion_rate: null, update_url: ''
            },

            // Banner Modal State
            showBannerModal: false,
            bannerIsSubmitting: false,
            currentBanner: {
                id: null, location: 'HOME_HERO', title: '', subtitle: '',
                background_color: '#312E81', background_opacity: 90,
                content_position: 'center-middle',
                button_text: '', button_link: '', order: 0, is_active: true, background_image_url: ''
            },

            // SEO Modal State
            showSeoModal: false,
            seoIsLoading: false,
            seoIsSubmitting: false,
            seoFormData: {
                id: null, page_name: '', page_path: '',
                meta_title: '', meta_description: '', update_url: ''
            },
            seoFormErrors: {},

            // Category Modal State
            showCategoryModal: false,
            categoryIsLoading: false,
            categoryIsSubmitting: false,
            categoryFormData: {
                id: null, name: '', page_title: '', description: '',
                sections: [], update_url: ''
            },
            categoryFormErrors: {},

            // Category Gallery State
            catShowGallery: false,
            catGalleryLoading: false,
            catGalleryImages: [],
            catActiveEditorId: null,

            // Receive Stock Modal State
            receiveStockData: {
                invoiceItemId: '', invoiceId: '', productId: '', productName: '',
                productSku: '', supplierId: '', supplierName: '',
                quotationId: '', batch_number: '',
                received_date: '{{ today_date|date:"Y-m-d" }}', expiry_date: '',
                quantity_to_receive: '', max_receivable: ''
            },

            // Edit Invoice Modal State
            currentInvoice: {
                invoice_id: '', status: '', payment_date: '', notes: '', update_url: ''
            },

            // Product Edit Modal State
            showProductEditModal: false,
            productEditIsLoading: false,
            productEditIsSubmitting: false,
            productEditData: {
                id: null, name: '', sku: '', description: '', members_only: false,
                is_featured: false, categories: [], suppliers: [], featured_image: null,
                gallery_images: [], update_url: '', selectedImageUrl: ''
            },
            productEditErrors: {},

            // Blog Modal State
            showBlogModal: false,
            blogIsLoading: false,
            blogIsSubmitting: false,
            blogProductSearch: '',
            blogFormData: {
                id: null, title: '', slug: '', content: '',
                post_type: 'NEWS', is_published: true,
                featured_image: null, featured_image_url: '',
                user_groups: [], related_products: [],
                related_products_title: ''
            },
            blogFormErrors: {},

            // Blog Gallery State
            blogShowGallery: false,
            blogGalleryLoading: false,
            blogGalleryImages: [],
            blogGalleryMode: 'content', // 'content' or 'featured'

            // --- COMPUTED PROPERTIES ---

            get selectedGalleryImages() {
                if (!this.productEditData.id) return [];
                return Alpine.store('images').galleryImages.filter(image =>
                    this.productEditData.gallery_images.includes(image.id)
                );
            },

            get pricingProfit() {
                const cost = this.pricingData.base_cost;
                const price = this.pricingData.selling_price;
                if (cost === null || cost === undefined || price === null || price === undefined) {
                    return null;
                }
                const profit = parseFloat(price) - parseFloat(cost);
                return profit > 0 ? profit : null;
            },

            // Passthroughs to Image Store Getters
            get filteredImages() { return Alpine.store('images').filteredImages; },
            get filteredProductsForModal() { return Alpine.store('images').filteredProductsForModal; },
            get filteredPostsForModal() { return Alpine.store('images').filteredPostsForModal; },
            get filteredProductsForBulkAssign() { return Alpine.store('images').filteredProductsForBulkAssign; },
            get filteredPostsForBulkAssign() { return Alpine.store('images').filteredPostsForBulkAssign; },


            // --- METHODS ---

            init() {
                const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (tokenInput) {
                    Alpine.store('globals').csrfToken = tokenInput.value;
                } else {
                    console.error('CSRF token not found on page.');
                }

                // Handle Tab Changes
                this.$watch('tab', (val) => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                window.addEventListener('hashchange', () => {
                    this.tab = window.location.hash || '#quotations';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            },

            // --- Banner Methods ---
            openBannerModal(banner = null) {
                if (banner) {
                    this.currentBanner = { ...banner };
                    if (this.currentBanner.background_opacity === undefined) this.currentBanner.background_opacity = 90;
                    if (!this.currentBanner.background_color) this.currentBanner.background_color = '#312E81';
                } else {
                    this.currentBanner = {
                        id: null, location: 'HOME_HERO', title: '', subtitle: '',
                        background_color: '#312E81', background_opacity: 90,
                        content_position: 'center-middle',
                        button_text: '', button_link: '', order: 0, is_active: true, background_image_url: ''
                    };
                }
                this.showBannerModal = true;
            },

            async submitBanner() {
                this.bannerIsSubmitting = true;
                const form = document.getElementById('banner-form');
                const formData = new FormData(form);

                if(!form.querySelector('[name=is_active]').checked) {
                    formData.set('is_active', 'False');
                } else {
                    formData.set('is_active', 'True');
                }

                let url = '{% url "api_save_banner" %}';
                if (this.currentBanner.id) {
                    url = `/manage/api/save-banner/${this.currentBanner.id}/`;
                }

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'X-CSRFToken': Alpine.store('globals').csrfToken},
                        body: formData
                    });
                    const data = await response.json();
                    if(data.success) {
                        Alpine.store('globals').showToast('Banner saved! Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        Alpine.store('globals').showToast('Error saving banner', 'error');
                    }
                } catch(e) { console.error(e); }
                finally { this.bannerIsSubmitting = false; }
            },

            async deleteBanner(id) {
                if(!confirm('Delete this banner?')) return;
                try {
                    const response = await fetch(`/manage/api/delete-banner/${id}/`, {
                        method: 'POST',
                        headers: {'X-CSRFToken': Alpine.store('globals').csrfToken}
                    });
                    if(response.ok) {
                        Alpine.store('globals').showToast('Banner deleted! Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    }
                } catch(e) { console.error(e); }
            },

            // --- SEO Methods ---
            async openSeoModal(seoId = null) {
                this.seoFormErrors = {};
                this.showSeoModal = true;

                if (typeof seoId === 'object') seoId = null;

                if (seoId) {
                    this.seoIsLoading = true;
                    try {
                        const response = await fetch(`/seo/manage/edit/${seoId}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch SEO data');
                        this.seoFormData = await response.json();
                    } catch (e) {
                        Alpine.store('globals').showToast('Error loading data: ' + e.message, 'error');
                        this.showSeoModal = false;
                    } finally {
                        this.seoIsLoading = false;
                    }
                } else {
                    this.seoIsLoading = false;
                    this.seoFormData = {
                        id: null,
                        page_name: '',
                        page_path: '',
                        meta_title: '',
                        meta_description: '',
                        update_url: '{% url "seo:manage_seo_create" %}'
                    };
                }
            },

            async submitSeoForm() {
                if (this.seoIsSubmitting) return;
                this.seoIsSubmitting = true;
                this.seoFormErrors = {};

                try {
                    const response = await fetch(this.seoFormData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(this.seoFormData)
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        Alpine.store('globals').showToast(data.message || 'Saved successfully! Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        this.seoFormErrors = data.errors || { '__all__': [data.error || 'An unknown error occurred'] };
                    }
                } catch (e) {
                    this.seoFormErrors = { '__all__': ['Network error: ' + e.message] };
                } finally {
                    this.seoIsSubmitting = false;
                }
            },

            // --- Category Methods ---
            async openCategoryModal(catId = null) {
                if (typeof catId === 'object') catId = null;

                this.categoryFormErrors = {};
                this.showCategoryModal = true;
                this.categoryIsLoading = true;

                if (catId) {
                    try {
                        const response = await fetch(`/manage/category/edit/${catId}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch data');
                        const data = await response.json();
                        if (data.sections) {
                            data.sections = data.sections.map(s => ({...s, uid: Date.now() + Math.random().toString(36).substr(2, 9)}));
                        }
                        this.categoryFormData = data;
                    } catch (e) {
                        Alpine.store('globals').showToast(e.message, 'error');
                        this.showCategoryModal = false;
                    }
                } else {
                    this.categoryFormData = {
                        id: null,
                        name: '',
                        page_title: '',
                        description: '',
                        sections: [],
                        update_url: '{% url "product:manage_category_create" %}'
                    };
                }

                this.categoryIsLoading = false;

                this.$nextTick(() => {
                    this.initCatTinyMCE('cat-desc-editor', null);
                    this.categoryFormData.sections.forEach((section) => {
                        this.initCatTinyMCE('cat-section-' + section.uid, section.uid);
                    });
                });
            },

            closeCategoryModal() {
                if (this.catShowGallery) {
                    this.catShowGallery = false;
                    return;
                }
                if (confirm('Are you sure you want to close? Unsaved changes will be lost.')) {
                    if (typeof tinymce !== 'undefined') {
                        tinymce.remove('#cat-desc-editor');
                        this.categoryFormData.sections.forEach((section) => {
                            tinymce.remove('#cat-section-' + section.uid);
                        });
                    }
                    this.showCategoryModal = false;
                }
            },

            initCatTinyMCE(elementId, sectionUid) {
                if (typeof tinymce === 'undefined') return;

                if (tinymce.get(elementId)) tinymce.remove('#' + elementId);

                tinymce.init({
                    selector: '#' + elementId,
                    height: 300,
                    menubar: false,
                    plugins: 'lists link image code table',
                    toolbar: 'undo redo | bold italic | bullist numlist | link image | code',
                    setup: (editor) => {
                        editor.on('init', () => {
                            if (sectionUid === null) {
                                editor.setContent(this.categoryFormData.description || '');
                            } else {
                                const section = this.categoryFormData.sections.find(s => s.uid === sectionUid);
                                if (section) editor.setContent(section.content || '');
                            }
                        });
                        editor.on('change keyup', () => {
                            const content = editor.getContent();
                            if (sectionUid === null) {
                                this.categoryFormData.description = content;
                            } else {
                                const section = this.categoryFormData.sections.find(s => s.uid === sectionUid);
                                if (section) section.content = content;
                            }
                        });
                    }
                });
            },

            addCategorySection() {
                const newUid = Date.now() + Math.random().toString(36).substr(2, 9);
                this.categoryFormData.sections.push({title: '', content: '', uid: newUid});
                this.$nextTick(() => {
                    this.initCatTinyMCE('cat-section-' + newUid, newUid);
                });
            },

            removeCategorySection(uid) {
                if (confirm('Remove section?')) {
                    const index = this.categoryFormData.sections.findIndex(s => s.uid === uid);
                    if (index > -1) {
                        tinymce.remove('#cat-section-' + uid);
                        this.categoryFormData.sections.splice(index, 1);
                    }
                }
            },

            async openCatGallery(editorId) {
                this.catActiveEditorId = editorId;
                this.catShowGallery = true;
                if (this.catGalleryImages.length === 0) {
                    this.catGalleryLoading = true;
                    try {
                        const res = await fetch("{% url 'images:ajax_get_images' %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
                        const data = await res.json();
                        this.catGalleryImages = data.images;
                    } catch(e) { console.error(e); }
                    finally { this.catGalleryLoading = false; }
                }
            },

            insertCatImage(url, alt) {
                const imgTag = `<img src="${url}" alt="${alt}" style="max-width:100%;" />`;
                const editor = tinymce.get(this.catActiveEditorId);
                if (editor) {
                    editor.focus();
                    editor.insertContent(imgTag);
                }
                this.catShowGallery = false;
            },

            async submitCategoryForm() {
                this.categoryIsSubmitting = true;
                this.categoryFormErrors = {};

                if (typeof tinymce !== 'undefined') tinymce.triggerSave();

                if (tinymce.get('cat-desc-editor')) {
                    this.categoryFormData.description = tinymce.get('cat-desc-editor').getContent();
                }

                this.categoryFormData.sections.forEach((section) => {
                    const editor = tinymce.get('cat-section-' + section.uid);
                    if (editor) {
                        section.content = editor.getContent();
                    }
                });

                try {
                    const res = await fetch(this.categoryFormData.update_url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(this.categoryFormData)
                    });
                    const data = await res.json();
                    if (res.ok && data.success) {
                        Alpine.store('globals').showToast(data.message + ' Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        this.categoryFormErrors = data.errors || {'__all__': [data.error]};
                    }
                } catch (e) {
                    Alpine.store('globals').showToast('Error: ' + e.message, 'error');
                } finally {
                    this.categoryIsSubmitting = false;
                }
            },

            // --- Invoice Methods ---
            async fetchInvoiceData(invoiceId) {
                try {
                    const url = `/sales/invoice/${invoiceId}/edit/`;
                    const response = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    if (!response.ok) { throw new Error(`Network response error (${response.status})`); }
                    this.currentInvoice = await response.json();
                    this.editModalOpen = true;
                } catch (error) {
                    console.error('Fetch invoice data error:', error);
                    Alpine.store('globals').showToast('Could not load invoice details.', 'error');
                }
            },

            async submitInvoiceUpdate() {
                const form = document.getElementById('edit-invoice-form'); if (!form) return;
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type=submit]');
                submitButton.disabled = true; submitButton.innerHTML = 'Saving...';
                try {
                    const response = await fetch(this.currentInvoice.update_url, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': Alpine.store('globals').csrfToken },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.editModalOpen = false;
                        Alpine.store('globals').showToast('Invoice updated successfully! Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        let errorMsg = 'Update failed:\n' + (data.error || '');
                        if (data.errors) {
                            for (const field in data.errors) {
                                errorMsg += `- ${field}: ${data.errors[field].join(', ')}\n`;
                            }
                        }
                        Alpine.store('globals').showToast(errorMsg, 'error');
                    }
                } catch (error) {
                    Alpine.store('globals').showToast('Network error during update.', 'error');
                } finally {
                    submitButton.disabled = false; submitButton.innerHTML = 'Save Changes';
                }
            },

            // --- Receive Stock Methods ---
            openReceiveStockModal(data) {
                if (!this.receiveStockModalOpen) {
                    this.receiveStockData.received_date = '{{ today_date|date:"Y-m-d" }}';
                    this.receiveStockData.batch_number = '';
                    this.receiveStockData.expiry_date = '';
                }
                this.receiveStockData = {
                    ...this.receiveStockData,
                    ...data,
                    quantity_to_receive: data.quantity,
                    max_receivable: data.quantity
                };
                this.receiveStockModalOpen = true;
            },
            closeReceiveStockModal() { this.receiveStockModalOpen = false; },

            // --- Pricing Methods ---
            openPricingModal(product) {
                const baseCost = product.base_cost ? parseFloat(product.base_cost) : null;
                let profitMargin = product.profit_margin ? parseFloat(product.profit_margin) : null;
                let sellingPrice = product.selling_price ? parseFloat(product.selling_price) : null;

                if (baseCost !== null) {
                    if (sellingPrice !== null && profitMargin === null) {
                        if (sellingPrice > 0) {
                            profitMargin = ((parseFloat(sellingPrice) - parseFloat(baseCost)) / parseFloat(sellingPrice)) * 100;
                        }
                    } else if (sellingPrice === null && profitMargin !== null) {
                        const marginDecimal = parseFloat(profitMargin) / 100;
                        if (marginDecimal < 1) {
                            sellingPrice = baseCost / (1 - marginDecimal);
                        }
                    }
                }

                this.pricingData = {
                    id: product.id,
                    name: product.name,
                    base_cost: baseCost,
                    profit_margin: profitMargin !== null ? Math.round(profitMargin) : null,
                    selling_price: sellingPrice ? parseFloat(sellingPrice.toFixed(2)) : null,
                    is_promotion: product.is_promotion || false,
                    promotion_rate: product.promotion_rate ? parseFloat(product.promotion_rate) : null,
                    update_url: `/api/manage-pricing/${product.id}/`
                };
                this.showPricingModal = true;
            },

            calculatePriceFromMargin() {
                const cost = this.pricingData.base_cost;
                const margin = this.pricingData.profit_margin;
                if (cost === null || cost === undefined || margin === null || margin === undefined) {
                    this.pricingData.selling_price = null;
                    return;
                }
                const marginDecimal = parseFloat(margin) / 100;
                if (marginDecimal >= 1) {
                    this.pricingData.selling_price = null;
                    return;
                }
                const price = parseFloat(cost) / (1 - marginDecimal);
                this.pricingData.selling_price = parseFloat(price.toFixed(2));
            },

            calculateMarginFromPrice() {
                const cost = this.pricingData.base_cost;
                const price = this.pricingData.selling_price;
                if (cost === null || cost === undefined || price === null || price === undefined || price === 0) {
                    this.pricingData.profit_margin = null;
                    return;
                }
                const margin = ((parseFloat(price) - parseFloat(cost)) / parseFloat(price)) * 100;
                this.pricingData.profit_margin = Math.round(margin);
            },

            async submitPricingUpdate() {
                if (this.pricingIsSubmitting) return;
                this.pricingIsSubmitting = true;

                const payload = {
                    profit_margin: this.pricingData.profit_margin,
                    selling_price: this.pricingData.selling_price,
                    is_promotion: this.pricingData.is_promotion,
                    promotion_rate: this.pricingData.promotion_rate
                };

                try {
                    const response = await fetch(this.pricingData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.showPricingModal = false;
                        Alpine.store('globals').showToast('Pricing updated successfully!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else {
                        Alpine.store('globals').showToast('Error updating pricing: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (err) {
                    Alpine.store('globals').showToast('A network error occurred: ' + err.message, 'error');
                } finally {
                    this.pricingIsSubmitting = false;
                }
            },

            // --- Product Edit Methods ---
            async openProductEditModal(productId) {
                this.productEditIsLoading = true;
                this.showProductEditModal = true;
                this.productEditErrors = {};

                try {
                    const url = `/manage/edit/${productId}/`;
                    const response = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    if (!response.ok) { throw new Error('Failed to load product data.'); }

                    const data = await response.json();
                    this.productEditData = data;
                } catch (err) {
                    this.productEditErrors = { '__all__': [err.message || 'Could not load data.'] };
                } finally {
                    this.productEditIsLoading = false;
                }
            },

            async submitProductEdit() {
                this.productEditIsSubmitting = true;
                this.productEditErrors = {};
                const formData = new FormData();
                formData.append('name', this.productEditData.name);
                formData.append('sku', this.productEditData.sku || '');
                formData.append('description_title', this.productEditData.description_title || '');
                formData.append('description', this.productEditData.description || '');

                if (this.productEditData.sections) {
                    formData.append('sections_data', JSON.stringify(this.productEditData.sections));
                }

                if (this.productEditData.members_only) {
                    formData.append('members_only', 'on');
                }

                if (this.productEditData.is_featured) {
                    formData.append('is_featured', 'on');
                }

                if (this.productEditData.featured_image) {
                    formData.append('featured_image', this.productEditData.featured_image);
                } else {
                    formData.append('featured_image', '');
                }

                this.productEditData.categories.forEach(id => formData.append('categories', id));
                this.productEditData.suppliers.forEach(id => formData.append('suppliers', id));
                this.productEditData.gallery_images.forEach(id => formData.append('gallery_images', id));

                try {
                    const response = await fetch(this.productEditData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json'
                        },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.showProductEditModal = false;
                        Alpine.store('globals').showToast('Product updated successfully!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else {
                        this.productEditErrors = data.errors || { '__all__': ['An unknown error occurred.'] };
                    }
                } catch (err) {
                    this.productEditErrors = { '__all__': [err.message || 'A network error occurred.'] };
                } finally {
                    this.productEditIsSubmitting = false;
                }
            },

            removeImageFromProductGallery(imageId) {
                if (!this.productEditData || !this.productEditData.gallery_images) return;
                this.productEditData.gallery_images = this.productEditData.gallery_images.filter(id => id !== imageId);
            },

            // --- Blog Methods ---
            async openBlogModal(postId = null) {
                if(typeof postId === 'object') postId = null;

                this.blogFormErrors = {};
                this.blogProductSearch = '';
                this.showBlogModal = true;

                if (postId) {
                    this.blogIsLoading = true;
                    try {
                        const res = await fetch(`/blog/api/get-details/${postId}/`, {
                             headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        });
                        const data = await res.json();
                        this.blogFormData = data;
                    } catch(e) {
                        Alpine.store('globals').showToast('Error loading post: ' + e.message, 'error');
                        this.showBlogModal = false;
                    } finally {
                        this.blogIsLoading = false;
                    }
                } else {
                    this.blogFormData = {
                        id: null, title: '', slug: '', content: '',
                        post_type: 'NEWS', is_published: true,
                        featured_image: null, featured_image_url: '',
                        user_groups: [], related_products: [],
                        related_products_title: 'Related Products'
                    };
                }

                this.$nextTick(() => {
                    this.initBlogTinyMCE();
                });
            },

            closeBlogModal() {
                if(confirm('Unsaved changes will be lost. Close?')) {
                    if (typeof tinymce !== 'undefined') tinymce.remove('#blog-content-editor');
                    this.showBlogModal = false;
                }
            },

            initBlogTinyMCE() {
                if (typeof tinymce === 'undefined') return;
                if (tinymce.get('blog-content-editor')) tinymce.remove('#blog-content-editor');

                tinymce.init({
                    selector: '#blog-content-editor',
                    height: 400,
                    menubar: false,
                    plugins: 'lists link image code table wordcount',
                    toolbar: 'undo redo | bold italic | bullist numlist | link | code',
                    setup: (editor) => {
                        editor.on('init', () => {
                            editor.setContent(this.blogFormData.content || '');
                        });
                        editor.on('change keyup', () => {
                            this.blogFormData.content = editor.getContent();
                        });
                    }
                });
            },

            async openBlogGallery(editorId) {
                this.blogGalleryMode = 'content';
                this.blogShowGallery = true;
                await this.loadBlogGalleryImages();
            },

            openBlogGalleryForFeatured() {
                this.blogGalleryMode = 'featured';
                this.blogShowGallery = true;
                this.loadBlogGalleryImages();
            },

            async loadBlogGalleryImages() {
                 if (this.blogGalleryImages.length === 0) {
                    this.blogGalleryLoading = true;
                    try {
                        const res = await fetch("{% url 'images:ajax_get_images' %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
                        const data = await res.json();
                        this.blogGalleryImages = data.images;
                    } catch(e) { console.error(e); }
                    finally { this.blogGalleryLoading = false; }
                }
            },

            insertBlogImage(img) {
                if (this.blogGalleryMode === 'featured') {
                    this.blogFormData.featured_image = img.id;
                    this.blogFormData.featured_image_url = img.url;
                } else {
                    // Insert into Editor
                    const html = `<img src="${img.url}" alt="${img.alt_text}" style="max-width:100%; height:auto;" class="my-4 rounded-lg shadow-sm"/>`;
                    const editor = tinymce.get('blog-content-editor');
                    if (editor) editor.insertContent(html);
                }
                this.blogShowGallery = false;
            },

            async submitBlogForm() {
                if(this.blogIsSubmitting) return;
                this.blogIsSubmitting = true;
                this.blogFormErrors = {};

                if (typeof tinymce !== 'undefined' && tinymce.get('blog-content-editor')) {
                    this.blogFormData.content = tinymce.get('blog-content-editor').getContent();
                }

                const url = this.blogFormData.id
                    ? `/blog/api/save/${this.blogFormData.id}/`
                    : `/blog/api/save/`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(this.blogFormData)
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        Alpine.store('globals').showToast(data.message + ' Reloading...');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        this.blogFormErrors = data.errors || {'__all__': [data.error]};
                    }
                } catch(e) {
                    Alpine.store('globals').showToast('Network error: ' + e.message, 'error');
                } finally {
                    this.blogIsSubmitting = false;
                }
            },

            // --- Image Passthrough Methods ---
            handleImageUpload(event) { Alpine.store('images').handleImageUpload(event); },
            deleteImage(id) { Alpine.store('images').deleteImage(id); },
            openAssignProductModal(image) { Alpine.store('images').openAssignProductModal(image); },
            openAssignPostModal(image) { Alpine.store('images').openAssignPostModal(image); },
            openBulkAssignModal() { Alpine.store('images').openBulkAssignModal(); },
            submitProductAssignment() { Alpine.store('images').submitProductAssignment(); },
            submitPostAssignment() { Alpine.store('images').submitPostAssignment(); },
            submitBulkAssignment() { Alpine.store('images').submitBulkAssignment(); },
            updateProductModalSelections() { Alpine.store('images').updateProductModalSelections(); },
            updatePostModalSelections() { Alpine.store('images').updatePostModalSelections(); }

        }));

        // --- 2. Table & Accordion Components ---

        Alpine.data('productAccordionRow', (productId) => ({
            id: productId,
            open: false,
            batches: [],
            isLoading: false,
            hasLoaded: false,
            async toggle() {
                this.open = !this.open;
                if (this.open && !this.hasLoaded) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/inventory/api/product-batches/${this.id}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch batch data.');
                        const data = await response.json();
                        this.batches = data.batches;
                        this.hasLoaded = true;
                    } catch (error) { console.error(`Failed to load batches for product ${this.id}:`, error); }
                    finally { this.isLoading = false; }
                }
            }
        }));

        Alpine.data('quotationAccordionRow', (quotationId) => ({
            id: quotationId,
            open: false,
            items: [],
            isLoading: false,
            hasLoaded: false,
            async toggle() {
                this.open = !this.open;
                if (this.open && !this.hasLoaded) {
                    this.isLoading = true;
                    try {
                        const response = await fetch(`/inventory/api/quotation-items/${this.id}/`, {
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                        });
                        if (!response.ok) throw new Error('Failed to fetch quotation items.');
                        const data = await response.json();
                        this.items = data.items;
                        this.hasLoaded = true;
                    } catch (error) { console.error(`Failed to load items for quotation ${this.id}:`, error); }
                    finally { this.isLoading = false; }
                }
            }
        }));

        Alpine.data('productTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            filterGroup: '',
            filterCategory: '',
            allCategories: [],
            groupCategoriesMap: {},
            init() {
                this.allCategories = Alpine.store('globals').allCategoriesFlat;
                this.groupCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                this.fetchProducts(1);
            },
            get availableCategories() {
                if (!this.filterGroup) return this.allCategories;
                const globalCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                if (globalCategoriesMap && globalCategoriesMap[this.filterGroup]) {
                    return globalCategoriesMap[this.filterGroup] || [];
                }
                return [];
            },
            async fetchProducts(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText, group: this.filterGroup, category: this.filterCategory });
                try {
                    const response = await fetch(`{% url 'product:api_manage_products' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch products:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() {
                this.filterText = ''; this.filterGroup = ''; this.filterCategory = '';
                this.fetchProducts(1);
            },
            setGroupFilter(groupName) {
                this.filterGroup = groupName;
                this.filterCategory = '';
                this.fetchProducts(1);
            },
            setCategoryFilter(categoryName) {
                this.filterCategory = categoryName;
                this.fetchProducts(1);
            },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('inventoryTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            filterGroup: '',
            filterCategory: '',
            allCategories: [],
            groupCategoriesMap: {},
            init() {
                this.allCategories = Alpine.store('globals').allCategoriesFlat;
                this.groupCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                this.fetchInventory(1);
            },
            get availableCategories() {
                if (!this.filterGroup) return this.allCategories;
                const globalCategoriesMap = Alpine.store('globals').groupCategoriesMap;
                if (globalCategoriesMap && globalCategoriesMap[this.filterGroup]) {
                    return globalCategoriesMap[this.filterGroup] || [];
                }
                return [];
            },
            async fetchInventory(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText, group: this.filterGroup, category: this.filterCategory });
                try {
                    const response = await fetch(`{% url 'inventory:api_manage_inventory' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch inventory:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() {
                this.filterText = ''; this.filterGroup = ''; this.filterCategory = ''; this.fetchInventory(1);
            },
            setGroupFilter(groupName) {
                this.filterGroup = groupName; this.filterCategory = ''; this.fetchInventory(1);
            },
            setCategoryFilter(categoryName) {
                this.filterCategory = categoryName;
                this.fetchInventory(1);
            },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('quotationsTableData', () => ({
            items: [],
            isLoading: true,
            pagination: {},
            filterText: '',
            init() { this.fetchQuotations(1); },
            async fetchQuotations(page = 1) {
                this.isLoading = true;
                const params = new URLSearchParams({ page, search: this.filterText });
                try {
                    const response = await fetch(`{% url 'inventory:api_manage_quotations' %}?${params.toString()}`, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    this.items = data.items; this.pagination = data.pagination;
                } catch (error) { console.error('Failed to fetch quotations:', error); }
                finally { this.isLoading = false; }
            },
            clearFilters() { this.filterText = ''; this.fetchQuotations(1); },
            formatPrice(value) {
                if (value === null || value === undefined) return 'N/A';
                return `RM ${Number(value).toFixed(2)}`;
            }
        }));

        Alpine.data('imageTabManager', () => ({
            isLoading: true,
            init() {
                if (Alpine.store('images').galleryImages.length > 0) {
                    this.isLoading = false;
                    return; // Already loaded
                }
                this.fetchInitialImageData();
            },
            async fetchInitialImageData() {
                this.isLoading = true;
                const apiHeaders = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
                try {
                    const [imagesRes, productsRes, postsRes] = await Promise.all([
                        fetch(`{% url 'images:ajax_get_images' %}`, { headers: apiHeaders }),
                        fetch(`{% url 'product:api_manage_products' %}?page=1&limit=10000`, { headers: apiHeaders }),
                        fetch(`{% url 'blog:api_manage_posts' %}?page=1&limit=10000`, { headers: apiHeaders })
                    ]);

                    if (!imagesRes.ok || !productsRes.ok || !postsRes.ok) {
                        throw new Error('One or more API requests failed');
                    }
                    const imagesData = await imagesRes.json();
                    const productsData = await productsRes.json();
                    const postsData = await postsRes.json();
                    Alpine.store('images').galleryImages = imagesData.images;
                    Alpine.store('images').allProducts = productsData.items;
                    Alpine.store('images').allPosts = postsData.items;
                    Alpine.store('globals').allImageCategories = imagesData.categories;
                } catch (error) {
                    console.error('Failed to load initial image data:', error);
                    Alpine.store('globals').showToast('Could not load image gallery data.', 'error');
                } finally {
                    this.isLoading = false;
                }
            }
        }));
    });
</script>

<script>
    function manageProductMixin() {
        return {
            // Pricing Modal State
            showPricingModal: false,
            pricingIsSubmitting: false,
            pricingData: {
                id: null, name: '', base_cost: null, profit_margin: null,
                selling_price: null, is_promotion: false, promotion_rate: null, update_url: '',
                supplier_costs: []
            },

            // Product Edit Modal State
            showProductEditModal: false,
            productEditIsLoading: false,
            productEditIsSubmitting: false,
            productEditData: {
                id: null, name: '', sku: '', description: '', origin_country: '',
                members_only: false, is_featured: false, is_best_seller: false, // <--- ADDED
                categories: [], suppliers: [], featured_image: null,
                gallery_images: [], update_url: '', selectedImageUrl: ''
            },
            productEditErrors: {},

            get pricingProfit() {
                const cost = this.pricingData.base_cost;
                const price = this.pricingData.selling_price;
                if (cost === null || cost === undefined || price === null || price === undefined) {
                    return null;
                }
                const profit = parseFloat(price) - parseFloat(cost);
                return profit > 0 ? profit : null;
            },

            get selectedGalleryImages() {
                if (!this.productEditData.id) return [];
                return Alpine.store('images').galleryImages.filter(image =>
                    this.productEditData.gallery_images.includes(image.id)
                );
            },

            // --- Pricing Methods ---
            openPricingModal(product) {
                const baseCost = product.base_cost ? parseFloat(product.base_cost) : null;
                let profitMargin = product.profit_margin ? parseFloat(product.profit_margin) : null;
                let sellingPrice = product.selling_price ? parseFloat(product.selling_price) : null;

                if (baseCost !== null) {
                    if (sellingPrice !== null && profitMargin === null) {
                        if (sellingPrice > 0) {
                            profitMargin = ((parseFloat(sellingPrice) - parseFloat(baseCost)) / parseFloat(sellingPrice)) * 100;
                        }
                    } else if (sellingPrice === null && profitMargin !== null) {
                        const marginDecimal = parseFloat(profitMargin) / 100;
                        if (marginDecimal < 1) {
                            sellingPrice = baseCost / (1 - marginDecimal);
                        }
                    }
                }

                const supplierCosts = product.supplier_costs || [];

                this.pricingData = {
                    id: product.id,
                    name: product.name,
                    base_cost: baseCost,
                    profit_margin: profitMargin !== null ? Math.round(profitMargin) : null,
                    selling_price: sellingPrice ? parseFloat(sellingPrice.toFixed(2)) : null,
                    is_promotion: product.is_promotion || false,
                    promotion_rate: product.promotion_rate ? parseFloat(product.promotion_rate) : null,
                    update_url: `/api/manage-pricing/${product.id}/`,
                    supplier_costs: supplierCosts
                };

                this.showPricingModal = true;
            },

            calculatePriceFromMargin() {
                const cost = this.pricingData.base_cost;
                const margin = this.pricingData.profit_margin;

                if (cost === null || cost === undefined || margin === null || margin === undefined) {
                    this.pricingData.selling_price = null;
                    return;
                }
                const marginDecimal = parseFloat(margin) / 100;
                if (marginDecimal >= 1) {
                    this.pricingData.selling_price = null;
                    return;
                }
                const price = parseFloat(cost) / (1 - marginDecimal);
                this.pricingData.selling_price = parseFloat(price.toFixed(2));
            },

            calculateMarginFromPrice() {
                const cost = this.pricingData.base_cost;
                const price = this.pricingData.selling_price;
                if (cost === null || cost === undefined || price === null || price === undefined || price === 0) {
                    this.pricingData.profit_margin = null;
                    return;
                }
                const margin = ((parseFloat(price) - parseFloat(cost)) / parseFloat(price)) * 100;
                this.pricingData.profit_margin = Math.round(margin);
            },

            async submitPricingUpdate() {
                if (this.pricingIsSubmitting) return;
                this.pricingIsSubmitting = true;

                const payload = {
                    profit_margin: this.pricingData.profit_margin,
                    selling_price: this.pricingData.selling_price,
                    is_promotion: this.pricingData.is_promotion,
                    promotion_rate: this.pricingData.promotion_rate
                };

                try {
                    const response = await fetch(this.pricingData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.showPricingModal = false;
                        Alpine.store('globals').showToast('Pricing updated successfully!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else {
                        Alpine.store('globals').showToast('Error updating pricing: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (err) {
                    Alpine.store('globals').showToast('A network error occurred: ' + err.message, 'error');
                } finally {
                    this.pricingIsSubmitting = false;
                }
            },

            // --- Product Edit Methods ---
            async openProductEditModal(productId) {
                this.productEditIsLoading = true;
                this.showProductEditModal = true;
                this.productEditErrors = {};

                try {
                    const url = `/manage/edit/${productId}/`;
                    const response = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
                    });
                    if (!response.ok) { throw new Error('Failed to load product data.'); }

                    const data = await response.json();
                    this.productEditData = data;
                } catch (err) {
                    this.productEditErrors = { '__all__': [err.message || 'Could not load data.'] };
                } finally {
                    this.productEditIsLoading = false;
                }
            },

            async submitProductEdit() {
                this.productEditIsSubmitting = true;
                this.productEditErrors = {};
                const formData = new FormData();
                formData.append('name', this.productEditData.name);
                formData.append('sku', this.productEditData.sku || '');
                formData.append('description_title', this.productEditData.description_title || '');
                formData.append('description', this.productEditData.description || '');
                formData.append('origin_country', this.productEditData.origin_country || '');

                if (this.productEditData.sections) {
                    formData.append('sections_data', JSON.stringify(this.productEditData.sections));
                }

                if (this.productEditData.members_only) {
                    formData.append('members_only', 'on');
                }

                if (this.productEditData.is_featured) {
                    formData.append('is_featured', 'on');
                }

                // --- NEW: Handle Best Seller ---
                if (this.productEditData.is_best_seller) {
                    formData.append('is_best_seller', 'on');
                }
                // ------------------------------

                if (this.productEditData.featured_image) {
                    formData.append('featured_image', this.productEditData.featured_image);
                } else {
                    formData.append('featured_image', '');
                }

                this.productEditData.categories.forEach(id => formData.append('categories', id));
                this.productEditData.suppliers.forEach(id => formData.append('suppliers', id));
                this.productEditData.gallery_images.forEach(id => formData.append('gallery_images', id));

                try {
                    const response = await fetch(this.productEditData.update_url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': Alpine.store('globals').csrfToken,
                            'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json'
                        },
                        body: formData
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        this.showProductEditModal = false;
                        Alpine.store('globals').showToast('Product updated successfully!');
                        window.dispatchEvent(new CustomEvent('refresh-data', { detail: { tab: 'products' } }));
                    } else {
                        this.productEditErrors = data.errors || { '__all__': ['An unknown error occurred.'] };
                    }
                } catch (err) {
                    this.productEditErrors = { '__all__': [err.message || 'A network error occurred.'] };
                } finally {
                    this.productEditIsSubmitting = false;
                }
            },

            removeImageFromProductGallery(imageId) {
                if (!this.productEditData || !this.productEditData.gallery_images) return;
                this.productEditData.gallery_images = this.productEditData.gallery_images.filter(id => id !== imageId);
            }
        };
    }
</script>
